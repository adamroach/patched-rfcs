<pre>






Network Working Group                                      J. Urpalainen
Request for Comments: 5261                                         Nokia
Category: Standards Track                                 September 2008


An Extensible Markup Language (XML) Patch Operations Framework Utilizing
                  XML Path Language (XPath) Selectors

Status of This Memo

   This document specifies an Internet standards track protocol for the
   Internet community, and requests discussion and suggestions for
   improvements.  Please refer to the current edition of the &quot;Internet
   Official Protocol Standards&quot; (STD 1) for the standardization state
   and status of this protocol.  Distribution of this memo is unlimited.

Abstract

   Extensible Markup Language (XML) documents are widely used as
   containers for the exchange and storage of arbitrary data in today&#39;s
   systems.  In order to send changes to an XML document, an entire copy
   of the new version must be sent, unless there is a means of
   indicating only the portions that have changed.  This document
   describes an XML patch framework utilizing XML Path language (XPath)
   selectors.  These selector values and updated new data content
   constitute the basis of patch operations described in this document.
   In addition to them, with basic &lt;add&gt;, &lt;replace&gt;, and &lt;remove&gt;
   directives a set of patches can then be applied to update an existing
   XML document.

Table of Contents

   1. Introduction ....................................................3
   2. Conventions .....................................................3
   3. Basic Features and Requirements .................................4
   4. Patch Operations ................................................5
      4.1. Locating the Target of a Patch .............................6
      4.2. Namespace Mangling .........................................6
           4.2.1. Namespaces Used in Selectors ........................7
           4.2.2. Departures from XPath Requirements ..................7
           4.2.3. Namespaces and Added/Changed Content ................8
      4.3. &lt;add&gt; Element .............................................10
           4.3.1. Adding an Element ..................................11
           4.3.2. Adding an Attribute ................................11
           4.3.3. Adding a Prefixed Namespace Declaration ............12
           4.3.4. Adding Node(s) with the &#39;pos&#39; Attribute ............12
           4.3.5. Adding Multiple Nodes ..............................12
      4.4. &lt;replace&gt; Element .........................................13



Urpalainen                  Standards Track                     [Page 1]

RFC 5261                    Patch Operations              September 2008


           4.4.1. Replacing an Element ...............................14
           4.4.2. Replacing an Attribute Value .......................14
           4.4.3. Replacing a Namespace Declaration URI ..............14
           4.4.4. Replacing a Comment Node ...........................14
           4.4.5. Replacing a Processing Instruction Node ............15
           4.4.6. Replacing a Text Node ..............................15
      4.5. &lt;remove&gt; Element ..........................................15
           4.5.1. Removing an Element ................................15
           4.5.2. Removing an Attribute ..............................16
           4.5.3. Removing a Prefixed Namespace Declaration ..........16
           4.5.4. Removing a Comment Node ............................16
           4.5.5. Removing a Processing Instruction Node .............16
           4.5.6. Removing a Text Node ...............................16
   5. Error Handling .................................................17
      5.1. Error Elements ............................................17
   6. Usage of Patch Operations ......................................19
   7. Usage of Selector Values .......................................19
   8. XML Schema Types of Patch Operation Elements ...................19
   9. XML Schema of Patch Operation Errors ...........................21
   10. IANA Considerations ...........................................23
      10.1. URN Sub-Namespace Registration ...........................23
      10.2. application/patch-ops-error+xml MIME Type ................24
      10.3. Patch-Ops-Types XML Schema Registration ..................25
      10.4. Patch-Ops-Error XML Schema Registration ..................25
   11. Security Considerations .......................................26
   12. Acknowledgments ...............................................26
   13. References ....................................................26
      13.1. Normative References .....................................26
      13.2. Informative References ...................................28
   Appendix A.  Informative Examples .................................29
     A.1.  Adding an Element .........................................29
     A.2.  Adding an Attribute .......................................29
     A.3.  Adding a Prefixed Namespace Declaration ...................30
     A.4.  Adding a Comment Node with the &#39;pos&#39; Attribute ............30
     A.5.  Adding Multiple Nodes .....................................31
     A.6.  Replacing an Element ......................................31
     A.7.  Replacing an Attribute Value ..............................32
     A.8.  Replacing a Namespace Declaration URI .....................32
     A.9.  Replacing a Comment Node ..................................33
     A.10. Replacing a Processing Instruction Node ...................33
     A.11. Replacing a Text Node .....................................34
     A.12. Removing an Element .......................................34
     A.13. Removing an Attribute .....................................35
     A.14. Removing a Prefixed Namespace Declaration .................35
     A.15. Removing a Comment Node ...................................36
     A.16. Removing a Processing Instruction Node ....................36
     A.17. Removing a Text Node ......................................37
     A.18. Several Patches With Namespace Mangling ...................38



Urpalainen                  Standards Track                     [Page 2]

RFC 5261                    Patch Operations              September 2008


1.  Introduction

   Extensible Markup Language (XML) [W3C.REC-xml-20060816] documents are
   widely used as containers for the exchange and storage of arbitrary
   data in today&#39;s systems.  In order to send changes to an XML
   document, an entire copy of the new version must be sent, unless
   there is a means of indicating only the portions that have changed
   (patches).

   This document describes an XML patch framework that utilizes XML Path
   language (XPath) [W3C.REC-xpath-19991116] selectors.  An XPath
   selector is used to pinpoint the specific portion of the XML that is
   the target for the change.  These selector values and updated new
   data content constitute the basis of patch operations described in
   this document.  In addition to them, with basic &lt;add&gt;, &lt;replace&gt;, and
   &lt;remove&gt; directives a set of patches can be applied to update an
   existing target XML document.  With these patch operations, a simple
   semantics for data oriented XML documents
   [W3C.REC-xmlschema-2-20041028] is achieved, that is, modifications
   like additions, removals, or substitutions of elements and attributes
   can easily be performed.  This document does not describe a full XML
   diff format, only basic patch operation elements that can be embedded
   within a full format that typically has additional semantics.

   As one concrete example, in the Session Initiation Protocol (SIP)
   [RFC3903] based presence system a partial PIDF XML document format
   [RFC5262] consists of the existing Presence Information Data Format
   (PIDF) document format combined with the patch operations elements
   described in this document.  In general, patch operations can be used
   in any application that exchanges XML documents, for example, within
   the SIP Events framework [RFC3265].  Yet another example is XCAP-diff
   [SIMPLE-XCAP], which uses this framework for sending partial updates
   of changes to XCAP [RFC4825] resources.

2.  Conventions

   The key words &quot;MUST&quot;, &quot;MUST NOT&quot;, &quot;REQUIRED&quot;, &quot;SHALL&quot;, &quot;SHALL NOT&quot;,
   &quot;SHOULD&quot;, &quot;SHOULD NOT&quot;, &quot;RECOMMENDED&quot;, &quot;MAY&quot;, and &quot;OPTIONAL&quot; in this
   document are to be interpreted as described in RFC 2119, BCP 14
   [RFC2119] and indicate requirement levels for compliant
   implementations.

   The following terms are used in this document:

   Target XML document:  A target XML document that is going to be
      updated with a set of patches.





Urpalainen                  Standards Track                     [Page 3]

RFC 5261                    Patch Operations              September 2008


   XML diff document:  An XML document that contains patch operation
      elements, namespace declarations, and all the document content
      changes that are needed in order to transform a target XML
      document into a new patched XML document.

   Patched XML document:  An XML document that results after applying
      one or more patch operations defined in the XML diff document to
      the target XML document.

   Patch operation:  A single change, i.e., a patch that is being
      applied to update a target XML document.

   Patch operation element:  An XML element that represents a single
      patch operation.

   Type definition for an element:  A World Wide Web Consortium (W3C)
      Schema type definition for an element that describes a patch
      operation content.

   In-scope namespace declaration:  A list of all in-scope namespace
      declarations within a context node.  The QName (qualified name)
      expansion of a context node is based on mapping a prefix with one
      of these declarations.  For an element, one namespace binding may
      have an empty prefix.

   Positional constraint:  A number enclosed with square brackets.  It
      can be used as a location step predicate.

   Located target node:  A node that was found from the target XML
      document with the aid of an XPath selector value.

   White space text node:  A text node that contains only white space.

3.  Basic Features and Requirements

   In this framework, XPath selector values and new data content are
   embedded within XML elements, the names of which specify the
   modification to be performed: &lt;add&gt;, &lt;replace&gt;, or &lt;remove&gt;.  These
   elements (patch operations) are defined by schema types with the W3C
   Schema language [W3C.REC-xmlschema-1-20041028].  XPath selectors
   pinpoint the target for a change and they are expressed as attributes
   of these elements.  The child node(s) of patch operation elements
   contain the new data content.  In general when applicable, the new
   content SHOULD be moved unaltered to the patched XML document.

   XML documents that are equivalent for the purposes of many
   applications MAY differ in their physical representation.  The aim of
   this document is to describe a deterministic framework where the



Urpalainen                  Standards Track                     [Page 4]

RFC 5261                    Patch Operations              September 2008


   canonical form with comments [W3C.REC-xml-c14n-20010315] of an XML
   document determines logical equivalence.  For example, white space
   text nodes MUST be processed properly in order to fulfill this
   requirement as white space is by default significant
   [W3C.REC-xml-c14n-20010315].

   The specifications referencing these element schema types MUST define
   the full XML diff format with an appropriate MIME type [RFC3023] and
   a character set, e.g., UTF-8 [RFC3629].  For example, the partial
   PIDF format [RFC5262] includes this schema and describes additional
   definitions to produce a complete XML diff format for partial
   presence information updates.

   As the schema defined in this document does not declare any target
   namespace, the type definitions inherit the target namespace of the
   including schema.  Therefore, additional namespace declarations
   within the XML diff documents can be avoided.

   It is anticipated that applications using these types will define
   &lt;add&gt;, &lt;replace&gt;, and &lt;remove&gt; elements based on the corresponding
   type definitions in this schema.  In addition, an application may
   reference only a subset of these type definitions.  A future
   extension can introduce other operations, e.g., with
   document-oriented models [W3C.REC-xmlschema-2-20041028], a &lt;move&gt;
   operation and a text node patching algorithm combined with &lt;move&gt;
   would undoubtedly produce smaller XML diff documents.

   The instance document elements based on these schema type definitions
   MUST be well formed and SHOULD be valid.

   The following XPath 1.0 data model node types can be added, replaced,
   or removed with this framework: elements, attributes, namespaces,
   comments, texts, and processing instructions.  The full XML prolog,
   including for example XML entities [W3C.REC-xml-20060816] and the
   root node of an XML document, cannot be patched according to this
   framework.  However, patching of comments and processing instructions
   of the root node is allowed.  Naturally, the removal or addition of a
   document root element is not allowed as any valid XML document MUST
   always contain a single root element.  Also, note that support for
   external entities is beyond the scope of this framework.

4.  Patch Operations

   An XML diff document contains a collection of patch operation
   elements, including one or more &lt;add&gt;, &lt;replace&gt;, and &lt;remove&gt;
   elements.  These patch operations will be applied sequentially in the
   document order.  After the first patch has been applied to update a
   target XML document, the patched XML document becomes a new



Urpalainen                  Standards Track                     [Page 5]

RFC 5261                    Patch Operations              September 2008


   independent XML document against which the next patch will be
   applied.  This procedure repeats until all patches have successfully
   been processed.

4.1.  Locating the Target of a Patch

   Each patch operation element contains a &#39;sel&#39; attribute.  The value
   of this attribute is an XPath selector with a restricted subset of
   the full XPath 1.0 recommendation.  The &#39;sel&#39; value is used to locate
   a single unique target node from the target XML document.  This
   located node pinpoints the target for a change and usually it is an
   element, which is for example either updated itself or some child
   node(s) are added into it.  It MAY also be, for instance, a comment
   node, after which some other sibling node(s) are inserted.  In any
   case, it is an error condition if multiple nodes are found during the
   evaluation of this selector value.

   The XPath selections of the &#39;sel&#39; attribute always start from the
   root node of a document.  Thus, relative location paths SHOULD be
   used so that the starting root node selection &quot;/&quot; can be omitted.
   When locating elements in a document tree, a node test can either be
   a &quot;*&quot; character or a QName [W3C.REC-xml-names-20060816].  A &quot;*&quot;
   character selects all element children of the context node.  Right
   after the node test, a location step can contain one or more
   predicates in any order.  An attribute value comparison is one of the
   most typical predicates.  The string value of the current context
   node or a child element may alternatively be used to identify
   elements in the tree.  The character &quot;.&quot;, which denotes a current
   context node selection, is an abbreviated form of &quot;self::node()&quot;.
   Lastly, positional constraints like &quot;[2]&quot; can also be used as an
   additional predicate.

   An XPath 1.0 &quot;id()&quot; node-set function MAY also be used to identify
   unique elements from the document tree.  The schema that describes
   the content model of the document MUST then use an attribute with the
   type ID [W3C.REC-xmlschema-2-20041028] or with non-validating XML
   parsers, an &quot;xml:id&quot; [W3C.WD-xml-id-20041109] attribute MUST have
   been used within an instance document.

4.2.  Namespace Mangling

   The normal model for namespace prefixes is that they are local in
   scope.  Thus, an XML diff document MAY have different prefixes for
   the namespaces used in the target document.  The agent parsing the
   diff document MUST resolve prefixes separately in both documents in
   order to match the resulting QNames (qualified name) from each.





Urpalainen                  Standards Track                     [Page 6]

RFC 5261                    Patch Operations              September 2008


   The XML diff document MUST contain declarations for all namespaces
   used in the diff document.  The diff document declarations are always
   used to determine what namespaces apply within the diff document.

4.2.1.  Namespaces Used in Selectors

   A selector in a diff document may use prefixes when naming elements.
   If it does use a prefix, the prefix must be looked up in the diff
   document namespace declarations.

      For example, the patch operation element of a diff document has an
      in-scope namespace declaration &quot;xmlns:a=&#39;foo:&#39;&quot; with a selector
      &quot;sel=&#39;a:bar&#39;&quot;.  The agent processing this patch MUST then look for
      a &#39;bar&#39; element qualified with the &#39;foo:&#39; namespace regardless of
      whether the &#39;foo:&#39; namespace has a prefix assigned in the target
      document or what that prefix is.

   Default namespaces make this model a little more complicated.  When
   the diff document has a default namespace declaration, any element
   selector without a prefix MUST be evaluated using that namespace.

      For example, the patch operation element of a diff document has an
      in-scope namespace declaration &quot;xmlns=&#39;foo:&#39;&quot; with a selector
      &quot;sel=&#39;bar&#39;&quot;.  The agent processing this patch MUST then look for a
      &#39;bar&#39; element qualified with the &#39;foo:&#39; namespace, regardless of
      whether the &#39;foo:&#39; namespace has a prefix assigned in the target
      document or what that prefix is.

   Unqualified names are also possible.  If there is no default
   namespace declared, and an element name appears without a prefix,
   then it is an unqualified element name.  If this appears in a
   selector, it MUST match an unqualified element in the target
   document.

      For example, the patch operation element of a diff document has
      only one in-scope namespace declaration &quot;xmlns:a=&#39;foo:&#39;&quot; with a
      selector &quot;sel=&#39;bar&#39;&quot;.  Since the &#39;bar&#39; element has no prefix, and
      there is no default namespace declaration in scope, the agent
      processing this patch can only match the selector against a &#39;bar&#39;
      element that has no prefix and also no default namespace in scope.

4.2.2.  Departures from XPath Requirements

</pre><div style='overflow:auto;border:dashed;margin:8px;padding:24px;background-color:#FFFFAF;'><b><i>Technical <a href='https://www.rfc-editor.org/errata/eid3477'>Errata 3477</a> updates this section as follows:</i></b><br/><br/><i><b>Old Text:</b></i><br/><pre style='margin:20px'>


In XPath 2.0, a &quot;bar&quot; selector
not only matches an unqualified &lt;bar&gt; element, but also matches a
qualified &lt;bar&gt; element that is in scope of a default namespace
declaration.  In contrast, in this specification, a selector without
a prefix only matches one element, and it may match an element with
or without a prefix but only if the namespace it's qualified with (or
none) is an exact match.
</pre><br/><i><b>New Text:</b></i><br/><pre style='margin:20px'>

In XPath 2.0, a &quot;bar&quot; selector matches elements that have the URI of 
the &quot;default element/type namespace&quot;, which is part of an XPath's 
static context. By setting this URI to the default namespace of the 
diff document (or leave it empty, if there is none), XPath 2.0's 
behavior matches the requirements of the previous section.
</pre><i><b>Errata Notes: </b>

The original text is not easy to understand, but seems to assume that an unprefixed name in XPath 2.0 matches both unprefixed names, and prefixed ones that have the same namespace than the default namespace of the XPath static context. This is not the case: Matching depends on how the &quot;default element/type namespace&quot; of the XPath static context is defined, and then matches either namespace-less elements, or those in the &quot;default element/type namespace&quot;, but never both. This context, however, is defined by the XPath itself, not by the document. Thus, it can be set externally and could be set to the diff document's default namespace (if there is one). In that case, XPath 2.0 can be used to evaluate XML Patch selectors.

</i></div><pre>

   The prefix matching rules described previously in this section are
   different from those required in XPath 1.0 and 2.0
   [W3C.REC-xpath20-20070123].  In XPath 1.0, a &quot;bar&quot; selector always
   locates an unqualified &lt;bar&gt; element.  In XPath 2.0, a &quot;bar&quot; selector
   not only matches an unqualified &lt;bar&gt; element, but also matches a



Urpalainen                  Standards Track                     [Page 7]

RFC 5261                    Patch Operations              September 2008


   qualified &lt;bar&gt; element that is in scope of a default namespace
   declaration.  In contrast, in this specification, a selector without
   a prefix only matches one element, and it may match an element with
   or without a prefix but only if the namespace it&#39;s qualified with (or
   none) is an exact match.

      The XPath 1.0 recommendation specifies &quot;namespace-uri()&quot; and
      &quot;local-name()&quot; node-set functions that can be used within
      predicates.  These functions may be utilized during XPath
      evaluations if there are no other means to &quot;register&quot; prefixes
      with associated namespace URIs.  They can also be used when
      handling selections where default namespaces are attached to
      elements.  However, this specification does not allow the usage of
      these functions.

4.2.3.  Namespaces and Added/Changed Content

</pre><div style='overflow:auto;border:dashed;margin:8px;padding:24px;background-color:#FFFFAF;'><b><i>Technical <a href='https://www.rfc-editor.org/errata/eid3465'>Errata 3465</a> updates this section as follows:</i></b><br/><br/><i><b>Old Text:</b></i><br/><pre style='margin:20px'>


- Lastly, if the above two rules still don't apply, first all
  in-scope namespace prefixes of the evaluation context node are
  arranged alphabetically in an ascending order. 
</pre><br/><i><b>New Text:</b></i><br/><pre style='margin:20px'>

n/a
</pre><i><b>Errata Notes: </b>

It is not entirely clear what &quot;arranged alphabetically&quot; refers to in this section. Sorting can be done in a variety of ways, and while many environment may have standard sort orders, not all are the same and for this standard to be implement consistently it's important to clearly state what sort order the above sentence is referring to. The suggested fix for this erratum is to add text that clearly states which sorting method should be used.

</i></div><pre>

   Elements within the changed data content are also in scope of
   namespace declarations.  For example, when adding a new namespace
   qualified element to the target XML document, the diff document MUST
   contain a namespace declaration that applies to the element.  The
   agent processing the diff document MUST ensure that the target
   document also contains the same namespace declaration.  Similar to
   XPath, the same namespace declaration in this context means that the
   namespace URIs MUST be equal, but the prefixes MAY be different in
   the diff and target documents.

      For example, if a new added &lt;a:bar&gt; element has a namespace
      declaration reference to &quot;xmlns:a=&#39;foo:&#39;&quot; in the diff document and
      the target document has only a single in-scope namespace
      declaration &quot;xmlns:b=&#39;foo:&#39;&quot; at the insertion point, the namespace
      reference MUST be changed so that a &lt;b:bar&gt; element will then
      exist in the patched document.  The same rule applies although
      default namespaces were used in either or both of the documents,
      the namespace URIs determine what will be the correct references
      (prefixes) in the patched document.

   When the new or changed content has elements that declare new
   namespaces (locally scoped), these declarations are copied unaltered
   (prefix and everything) from the XML diff document to the target XML
   document.  Default namespace declarations can only be added in this
   way, but prefixed namespace declarations MAY be added or removed with
   XPath namespace axis semantics shown later in this document (look
   Section 4.3.3).

   A fairly difficult use case for these rules is found when the target
   document has several namespace declarations in scope for the same
   namespace.  A target document might declare several different



Urpalainen                  Standards Track                     [Page 8]

RFC 5261                    Patch Operations              September 2008


   prefixes for the same namespace.  Normally, the agent applying the
   diff document chooses *the* appropriate prefix for adding new
   elements to the target document, but in this special case there&#39;s
   more than one.  These requirements create deterministic behavior for
   this special and in practice rare case:

   - If the diff document happens to use a prefix that is one of the
     prefixes declared for the same namespace in the evaluation context
     node of the target document, this prefix MUST be used in the
     resulting patched document.  An empty evaluable prefix and an
     existing in-scope default namespace declaration means that the
     default namespace MUST be chosen.  In other words, the expanded
     names are then equal within the diff and patched documents.

         In an &lt;add&gt; operation, the evaluation context node is the
         parent element of the inserted node, for example, with a
         selector &quot;sel=&#39;*/ bar&#39;&quot; and without a &#39;pos&#39; attribute directive
         (look Section 4.3), it is the &lt;bar&gt; element of the root
         document element.  With modifications of elements, the
         evaluation context node is the parent element of the modified
         element, and in the previous example thus the root document
         element.

   - Secondly, the prefix (also empty) of the evaluation context node
     MUST be chosen if the namespace URIs are equal.

   - Lastly, if the above two rules still don&#39;t apply, first all
     in-scope namespace prefixes of the evaluation context node are
     arranged alphabetically in an ascending order.  If a default
     namespace declaration exists, it is interpreted as the first entry
     in this list.  The prefix from the list is then chosen that appears
     as the closest and just before the compared prefix if it were
     inserted into the list.  If the compared prefix were to exist
     before the first prefix, the first prefix in the list MUST be
     selected (i.e., there&#39;s no default namespace).

         For example, if the list of in-scope prefixes in the target
         document is &quot;x&quot;, &quot;y&quot; and the compared prefix in the diff
         document is &quot;xx&quot;, then the &quot;x&quot; prefix MUST be chosen.  If an
         &quot;a&quot; prefix were evaluated, the &quot;x&quot; prefix, the first entry MUST
         be chosen.  If there were also an in-scope default namespace
         declaration, an evaluable &quot;a&quot; prefix would then select the
         default declaration.  Note that unprefixed attributes don&#39;t
         inherit the default namespace declaration.  When adding
         qualified attributes, the default namespace declaration is then
         not on this matching list of prefixes (see Section 4.3.2).





Urpalainen                  Standards Track                     [Page 9]

RFC 5261                    Patch Operations              September 2008


   Note that these requirements might mean that a resulting patched
   document could contain unused and/or superfluous namespace
   declarations.  The resulting patched document MUST NOT be &quot;cleaned
   up&quot; such that these namespace declarations are removed.

      Note: In practice, the agent constructing a diff document can
      usually freely select the appropriate prefixes for the namespace
      declarations and it doesn&#39;t need to know or care about the actual
      prefixes in the target document unless there are overlapping
      declarations.  In other words, the diff format content is
      typically independent of the target documents usage of namespace
      prefixes.  However, it may be very useful to know where namespaces
      are declared in the target document.  The most typical use case is
      such though, that the agent generating a diff has both the
      previous (target) and new (patched) documents available, and
      namespace declarations are thus exactly known.  Note also, that in
      a case where the target document is not exactly known, it is
      allowed to use locally scoped namespace declarations, the
      consequences of which are larger and less human-readable patched
      documents.

4.3.  &lt;add&gt; Element

   The &lt;add&gt; element represents the addition of some new content to the
   target XML document: for example, a new element can be appended into
   an existing element.

   The new data content exists as the child node(s) of the &lt;add&gt;
   element.  When adding attributes and namespaces, the child node of
   the &lt;add&gt; element MUST be a single text node.  Otherwise, the &lt;add&gt;
   element MAY contain any mixture of element, text, comment or
   processing instruction nodes in any order.  All children of the &lt;add&gt;
   element are then copied into a target XML document.  The described
   namespace mangling procedure applies to added elements, which include
   all of their attribute, namespace and descendant nodes.

   The &lt;add&gt; element type has three attributes: &#39;sel&#39;, &#39;type&#39;, and
   &#39;pos&#39;.

   The value of the optional &#39;type&#39; attribute is only used when adding
   attributes and namespaces.  Then, the located target node MUST be an
   element into which new attributes and namespace declarations are
   inserted.  When the value of this &#39;type&#39; attribute equals &quot;@attr&quot;,
   the string &quot;attr&quot; is the name of the actual attribute being added.
   The value of this new &#39;attr&#39; attribute is the text node content of
   the &lt;add&gt; element.  The less frequently used prefixed (i.e.,
   namespace-qualified) attributes can also be added.  If the value of
   the &#39;type&#39; attribute equals &quot;namespace::pref&quot;, &quot;pref&quot; is the actual



Urpalainen                  Standards Track                    [Page 10]

RFC 5261                    Patch Operations              September 2008


   prefix string to be used for the namespace declaration in the patched
   document and the text node content of the &lt;add&gt; element contains the
   corresponding namespace URI.

      Note: The &#39;type&#39; attribute is thus also an XPath selector, but it
      only locates attributes and namespaces.  Attribute axis
      &quot;attribute&quot; has an abbreviated form &quot;@&quot; unlike the &quot;namespace&quot;
      axis, which doesn&#39;t have an abbreviated form.  Double colons &quot;::&quot;
      are used as an axis separator in XPath.

   The value of the optional &#39;pos&#39; attribute indicates the positioning
   of new data content.  It is not used when adding attributes or
   namespaces.  When neither &#39;type&#39; nor &#39;pos&#39; attribute exist, the
   children of the &lt;add&gt; element are then appended as the last child
   node(s) of the located target element.  When the value of &#39;pos&#39;
   attribute is &quot;prepend&quot; the new node(s) are added as the first child
   node(s) of the located target element.  With the value of &quot;before&quot;,
   the added new node(s) MUST be the immediate preceding sibling
   node(s), and with &quot;after&quot;, the immediate following sibling node(s) of
   the located target node.

   Some examples follow that describe the use cases of these &lt;add&gt;
   element attributes.  The nodes are not namespace qualified and
   prefixes are therefore not used, and the whole XML diff content is
   not shown in these examples, only patch operation elements.  Full
   examples are given in an Appendix A.

4.3.1.  Adding an Element

   An example for an addition of an element:

   &lt;add sel=&quot;doc&quot;&gt;&lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/add&gt;

   Once the &lt;doc&gt; element has been found from the target XML document, a
   new &lt;foo&gt; element is appended as the last child node of the &lt;doc&gt;
   element.  The located target node: the &lt;doc&gt; element is naturally the
   root element of the target XML document.  The new &lt;foo&gt; element
   contains an &#39;id&#39; attribute and a child text node.

4.3.2.  Adding an Attribute

   An example for an addition of an attribute:

   &lt;add sel=&quot;doc/foo[@id=&#39;ert4773&#39;]&quot; type=&quot;@user&quot;&gt;Bob&lt;/add&gt;

   This operation adds a new &#39;user&#39; attribute to the &lt;foo&gt; element that
   was located by using an &#39;id&#39; attribute value predicate.  The value of
   this new &#39;user&#39; attribute is &quot;Bob&quot;.



Urpalainen                  Standards Track                    [Page 11]

RFC 5261                    Patch Operations              September 2008


   A similar patched XML document is achieved when using a validating
   XML parser, if the &#39;sel&#39; selector value had been &#39;id(&quot;ert4773&quot;)&#39; and
   if the data type of the &#39;id&#39; attribute is &quot;ID&quot;
   [W3C.REC-xmlschema-2-20041028].

   Note that with namespace qualified attributes, the prefix matching
   rules within the &#39;type&#39; attribute are evaluated with similar rules
   described in Section 4.2.3.  Also, note that then the possible
   default namespace declaration of the context element isn&#39;t
   applicable.

      Note: As the &#39;sel&#39; selector value MAY contain quotation marks,
      escaped forms: &quot;&amp;quot;&quot; or &quot;&amp;apos;&quot; can be used within attribute
      values.  However, it is often more appropriate to use the
      apostrophe (&#39;) character as shown in these examples.  An
      alternative is also to interchange the apostrophes and quotation
      marks.

4.3.3.  Adding a Prefixed Namespace Declaration

   An example for an addition of a prefixed namespace declaration:

   &lt;add sel=&quot;doc&quot; type=&quot;namespace::pref&quot;&gt;urn:ns:xxx&lt;/add&gt;

   This operation adds a new namespace declaration to the &lt;doc&gt; element.
   The prefix of this new namespace node is thus &quot;pref&quot; and the
   namespace URI is &quot;urn:ns:xxx&quot;.

4.3.4.  Adding Node(s) with the &#39;pos&#39; Attribute

   An example for an addition of a comment node:

   &lt;add
     sel=&quot;doc/foo[@id=&#39;ert4773&#39;]&quot; pos=&quot;before&quot;&gt;&lt;!-- comment --&gt;&lt;/add&gt;

   This operation adds a new comment node just before the &lt;foo&gt; element
   as an immediate preceding sibling node.  This is also an example how
   a &#39;pos&#39; attribute directive can be used.

4.3.5.  Adding Multiple Nodes

   Some complexity arises when so-called white space text nodes exist
   within a target XML document.  The XPath 1.0 data model requires that
   a text node MUST NOT have another text node as an immediate sibling
   node.  For instance, if an add operation is like this:

   &lt;add sel=&quot;doc&quot;&gt;
     &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/add&gt;



Urpalainen                  Standards Track                    [Page 12]

RFC 5261                    Patch Operations              September 2008


   The &lt;add&gt; element then has two child nodes: a white space text node
   (a linefeed and two spaces) and a &lt;foo&gt; element.  If the existing
   last child of the &lt;doc&gt; element is a text node, its content and the
   white space text node content MUST then be combined together.
   Otherwise, (white space) text nodes can be added just like elements,
   and thus, the canonical form of the patched XML document easily
   remains deterministic.  As several sibling nodes can be inserted with
   a single &lt;add&gt; operation, a &quot;pretty printing&quot; style can easily be
   maintained.

   Still another example about the handling of text nodes.  Consider
   this example:

   &lt;add sel=&quot;*/foo/text()[2]&quot; pos=&quot;after&quot;&gt;new&lt;bar/&gt;elem&lt;/add&gt;

   The second text node child of the &lt;foo&gt; element is first located.
   The added new content contains two text nodes and an element.  As
   there cannot be immediate sibling text nodes, the located target text
   node content and the first new text node content MUST be combined
   together.  In essence, if the &#39;pos&#39; value had been &quot;before&quot;, the
   second new text node content would effectively have been prepended to
   the located target text node.

      Note: It is still worth noting that text nodes MAY contain CDATA
      sections, the latter of which are not treated as separate nodes.
      Once these CDATA sections exist within the new text nodes, they
      SHOULD be moved unaltered to the patched XML document.

   While XML entities [W3C.REC-xml-20060816] cannot be patched with this
   framework, the references to other than predefined internal entities
   can exist within text nodes or attributes when the XML prolog
   contains those declarations.  These references may then be preserved
   if both the XML diff and the target XML document have identical
   declarations within their prologs.  Otherwise, references may be
   replaced with identical text as long as the &quot;canonically equivalent&quot;
   rule is obeyed.

4.4.  &lt;replace&gt; Element

   The &lt;replace&gt; element represents a replacement operation: for
   example, an existing element is updated with a new element or an
   attribute value is replaced with a new value.  This &lt;replace&gt;
   operation always updates a single node or node content at a time.

   The &lt;replace&gt; element type only has a &#39;sel&#39; attribute.  If the
   located target node is an element, a comment or a processing
   instruction, then the child of the &lt;replace&gt; element MUST also be of
   the same type.  Otherwise, the &lt;replace&gt; element MUST have text



Urpalainen                  Standards Track                    [Page 13]

RFC 5261                    Patch Operations              September 2008


   content or it MAY be empty when replacing an attribute value or a
   text node content.

4.4.1.  Replacing an Element

   An example for a replacement of an element:

   &lt;replace sel=&quot;doc/foo[@a=&#39;1&#39;]&quot;&gt;&lt;bar a=&quot;2&quot;/&gt;&lt;/replace&gt;

   This will update the &lt;foo&gt; element that has an &#39;a&#39; attribute with
   value &quot;1&quot;.  The located target element is replaced with the &lt;bar&gt;
   element.  So all descendant nodes, namespace declarations, and
   attributes of the replaced &lt;foo&gt; element, if any existed, are thus
   removed.

4.4.2.  Replacing an Attribute Value

   An example for a replacement of an attribute value:

   &lt;replace sel=&quot;doc/@a&quot;&gt;new value&lt;/replace&gt;

   This will replace the &#39;a&#39; attribute content of the &lt;doc&gt; element with
   the value &quot;new value&quot;.  If the &lt;replace&gt; element is empty, the &#39;a&#39;
   attribute MUST then remain in the patched XML document appearing like
   &lt;doc a=&quot;&quot;/&gt;.

4.4.3.  Replacing a Namespace Declaration URI

</pre><div style='overflow:auto;border:dashed;margin:8px;padding:24px;background-color:#FFFFAF;'><b><i>Technical <a href='https://www.rfc-editor.org/errata/eid3478'>Errata 3478</a> updates this section as follows:</i></b><br/><br/><i><b>Old Text:</b></i><br/><pre style='margin:20px'>


4.4.3. Replacing a Namespace Declaration URI


   An example for a replacement of a namespace URI:

   &lt;replace sel=&quot;doc/namespace::pref&quot;&gt;urn:new:xxx&lt;/replace&gt;

   This will replace the URI value of 'pref' prefixed namespace node
   with &quot;urn:new:xxx&quot;.  The parent node of the namespace declaration
   MUST be the &lt;doc&gt; element, otherwise an error occurs.
</pre><br/><i><b>New Text:</b></i><br/><pre style='margin:20px'>

4.4.3. Replacing a Namespace URI


   An example for a replacement of a namespace URI:

   &lt;replace sel=&quot;doc/namespace::pref&quot;&gt;urn:new:xxx&lt;/replace&gt;

   This will replace the URI of the namespace associated with the
   'pref' prefix with &quot;urn:new:xxx&quot;. The parent node of the namespace
   declaration MUST be the &lt;doc&gt; element, otherwise an error occurs.
   Replacing the namespace at the element where it is declared MUST
   also change all namespace nodes derived from this declaration in
   descendant elements. 
</pre><i><b>Errata Notes: </b>

The spec uses the terms &quot;namespace declaration&quot; and &quot;namespace&quot; almost interchangeably, which is incorrect. It is impossible to select (and thus patch) *namespace declarations* using XPath. When selecting and replacing a *namespace*, then it should be taken into account that the *namespace declaration* very likely has resulted in numerous namespace nodes, attached to child elements of the element where the namespace was declared. It is likely that the spec intended to specify a &quot;recursive replace&quot; of the resulting namespace nodes of a namespace declaration, and this is what the corrected text suggests. The original text is mixing terminology, hard to read, and ambiguous in its meaning.

If the spec text instead tried to specify that really only this one namespace node should be changed, then this can lead to rather strange effects in the resulting document, since the XPath tree now has &quot;orphan&quot; namespace nodes, which then need to be serialized and namespace declarations in locations where previously no namespace declarations occurred.

One way or the other, this ambiguity needs to be clarified to make the spec easier to read and implement.

</i></div><pre>

   An example for a replacement of a namespace URI:

   &lt;replace sel=&quot;doc/namespace::pref&quot;&gt;urn:new:xxx&lt;/replace&gt;

   This will replace the URI value of &#39;pref&#39; prefixed namespace node
   with &quot;urn:new:xxx&quot;.  The parent node of the namespace declaration
   MUST be the &lt;doc&gt; element, otherwise an error occurs.

4.4.4.  Replacing a Comment Node

   An example for a replacement of a comment node:

   &lt;replace sel=&quot;doc/comment()[1]&quot;&gt;&lt;!-- This is the new content
   --&gt;&lt;/replace&gt;

   This will replace a comment node.  The located target node is the
   first comment node child of the &lt;doc&gt; element.






Urpalainen                  Standards Track                    [Page 14]

RFC 5261                    Patch Operations              September 2008


4.4.5.  Replacing a Processing Instruction Node

   An example for a replacement of a processing instruction node:

   &lt;replace sel=&#39;doc/processing-instruction(&quot;test&quot;)&#39;&gt;&lt;?test bar=&quot;foobar&quot;
   ?&gt;&lt;/replace&gt;

   This will replace the processing instruction node &quot;test&quot; whose parent
   is the &lt;doc&gt; element.

4.4.6.  Replacing a Text Node

   An example for a replacement of a text node:

   &lt;replace
   sel=&quot;doc/foo/text()[1]&quot;&gt;This is the new text content&lt;/replace&gt;

   This will replace the first text node child of the &lt;foo&gt; element.
   The positional constraint &quot;[1]&quot; is not usually needed as the element
   content is rarely of mixed type [W3C.REC-xmlschema-1-20041028] where
   several text node siblings typically exist.

   If a text node is updated and the &lt;replace&gt; element is empty, the
   text node MUST thus be removed as a text node MUST always have at
   least one character of data.

4.5.  &lt;remove&gt; Element

   The &lt;remove&gt; element represents a removal operation of, for example,
   an existing element or an attribute.

   The &lt;remove&gt; element type has two attributes: &#39;sel&#39; and &#39;ws&#39;.  The
   value of the optional &#39;ws&#39; attribute is used to remove the possible
   white space text nodes that exist either as immediate following or
   preceding sibling nodes of the located target node.  The usage of
   &#39;ws&#39; attribute is only allowed when removing other types than text,
   attribute and namespace nodes.  If the value of &#39;ws&#39; is &quot;before&quot;, the
   purpose is to remove the immediate preceding sibling node that MUST
   be a white space text node and if the value is &quot;after&quot;, the
   corresponding following node.  If the &#39;ws&#39; value is &quot;both&quot;, both the
   preceding and following white space text nodes MUST be removed.

4.5.1.  Removing an Element

   An example of a removal of an element including all of its
   descendant, attribute, and namespace nodes:

   &lt;remove sel=&quot;doc/foo[@a=&#39;1&#39;]&quot; ws=&quot;after&quot;/&gt;



Urpalainen                  Standards Track                    [Page 15]

RFC 5261                    Patch Operations              September 2008


   This will remove the &lt;foo&gt; element as well as the immediate following
   sibling white space text node of the &lt;foo&gt; element.  If the immediate
   following sibling node is not a white space text node, an error
   occurs.

4.5.2.  Removing an Attribute

   An example for a removal of an attribute node:

   &lt;remove sel=&quot;doc/@a&quot;/&gt;

   This will remove the &#39;a&#39; attribute node from the &lt;doc&gt; element.

4.5.3.  Removing a Prefixed Namespace Declaration

   An example for a removal of a prefixed namespace node:

   &lt;remove sel=&quot;doc/foo/namespace::pref&quot;/&gt;

   This will remove the &#39;pref&#39; prefixed namespace node from the &lt;foo&gt;
   element.  Naturally, this prefix MUST NOT be associated with any node
   prior to the removal of this namespace node.  Also, the parent node
   of this namespace declaration MUST be the &lt;foo&gt; element.

4.5.4.  Removing a Comment Node

   An example for a removal of a comment node:

   &lt;remove sel=&quot;doc/comment()[1]&quot;/&gt;

   This will remove the first comment node child of the &lt;doc&gt; element.

4.5.5.  Removing a Processing Instruction Node

   An example for a removal of a processing instruction node:

   &lt;remove sel=&#39;doc/processing-instruction(&quot;test&quot;)&#39;/&gt;

   This will remove the &quot;test&quot; processing instruction node child of the
   &lt;doc&gt; element.

4.5.6.  Removing a Text Node

   An example for a removal of a text node:

   &lt;remove sel=&quot;doc/foo/text()[1]&quot;/&gt;

   This will remove the first text node child of the &lt;foo&gt; element.



Urpalainen                  Standards Track                    [Page 16]

RFC 5261                    Patch Operations              September 2008


   When removing an element, a comment, or a processing instruction node
   that has immediate preceding and following sibling text nodes without
   the &#39;ws&#39; directive, the content of these two text nodes MUST be
   combined together.  The latter text node thus disappears from the
   document.

5.  Error Handling

   It is an error condition if any of the patch operations cannot be
   unambiguously fulfilled.  In other words, once a particular patch
   operation fails, it is an error condition and processing of further
   patch operations is hardly sensible.

   A new MIME error format is defined for applications that require
   deterministic error handling when patching cannot be applied.  It is
   anticipated that these error elements can be used within other MIME
   types that allow extension elements.

5.1.  Error Elements

   The root element of the error document is &lt;patch-ops-error&gt;.  The
   content of this element is a specific error condition.  Each error
   condition is represented by a different element.  This allows for
   different error conditions to provide different data about the nature
   of the error.  All error elements support a &quot;phrase&quot; attribute, which
   can contain text meant for rendering to a human user.  The optional
   &quot;xml:lang&quot; MAY be used to describe the language of the &quot;phrase&quot;
   attribute.  Most of the error condition elements are supposed to
   contain the patch operation element that caused the patch to fail.

   The following error elements are defined by this specification:

   &lt;invalid-attribute-value&gt;:  The validity constraints of &#39;sel&#39;,
      &#39;type&#39;, &#39;ws&#39;, or &#39;pos&#39; attribute values MAY be indicated with this
      error, i.e., non-allowable content has been used.  Also, this
      error can be used to indicate if an added or a modified attribute
      content is not valid, for example, CDATA sections were used when a
      new attribute was intended to be added.

   &lt;invalid-character-set&gt;:  The patch could not be applied because the
      diff and the patched document use different character sets.

   &lt;invalid-diff-format&gt;:  This indicates that the diff body of the
      request was not a well-formed XML document or a valid XML document
      according to its schema.

   &lt;invalid-entity-declaration&gt;:  An entity reference was found but
      corresponding declaration could not be located or resolved.



Urpalainen                  Standards Track                    [Page 17]

RFC 5261                    Patch Operations              September 2008


   &lt;invalid-namespace-prefix&gt;:  The namespace URI for the given prefix
      could not be located or resolved, e.g., within the &#39;sel&#39; attribute
      a prefix was used but its declaration is missing from the target
      document.

   &lt;invalid-namespace-uri&gt;:  The namespace URI value is not valid or the
      target document did not have this declaration.

   &lt;invalid-node-types&gt;:  The node types of a &lt;replace&gt; operation did
      not match, i.e., for example, the &#39;sel&#39; selector locates an
      element but the replaceable content is of text type.  Also, a
      &lt;replace&gt; operation may locate a unique element, but replaceable
      content had multiple nodes.

   &lt;invalid-patch-directive&gt;:  A patch directive could not be fulfilled
      because the given directives were not understood.

   &lt;invalid-root-element-operation&gt;:  The root element of the document
      cannot be removed or another sibling element for the document root
      element cannot be added.

   &lt;invalid-xml-prolog-operation&gt;:  Patch failure related to XML prolog
      nodes.

   &lt;invalid-whitespace-directive&gt;:  A &lt;remove&gt; operation requires a
      removal of a white space node that doesn&#39;t exist in the target
      document.

   &lt;unlocated-node&gt;:  A single unique node (typically an element) could
      not be located with the &#39;sel&#39; attribute value.  Also, the location
      of multiple nodes can lead to this error.

   &lt;unsupported-id-function&gt;:  The nodeset function id() is not
      supported, and thus attributes with the ID type are not known.

   &lt;unsupported-xml-id&gt;:  The attribute xml:id as an ID attribute in XML
      documents is not supported.

   Additional error elements can be indicated within the root
   &lt;patch-ops-error&gt; element from any namespace.  However, the IETF MAY
   specify additional error elements in the
   &quot;urn:ietf:params:xml:ns:patch-ops-error&quot; namespace.

   As an example, the following document indicates that it was attempted
   to add a new &lt;note&gt; element with white space into a document, but the
   parent element could not be located:





Urpalainen                  Standards Track                    [Page 18]

RFC 5261                    Patch Operations              September 2008


   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;patch-ops-error
    xmlns:p=&quot;urn:ietf:params:xml:ns:pidf-diff&quot;
    xmlns=&quot;urn:ietf:params:xml:ns:patch-ops-error&quot;&gt;
    &lt;unlocated-node
     phrase=&quot;a unique node could not be located with the id() function.&quot;
     &gt;&lt;p:add sel=&#39;id(&quot;ert4773&quot;)&#39;&gt;
       &lt;p:note&gt;some text added&lt;/p:note&gt;
     &lt;/p:add&gt;&lt;/unlocated-node&gt;
   &lt;/patch-ops-error&gt;

6.  Usage of Patch Operations

   An XML diff document SHOULD contain only the nodes that have been
   modified as the intention is to try to reduce bandwidth/storage
   requirements.  However, when there&#39;s a large collection of changes it
   can be desirable to exchange the full document content instead.  How
   this will be done in practice is beyond the scope of this document.

   Some applications MAY require that the full versioning history MUST
   be indicated although the history had superfluous changes.  This
   framework doesn&#39;t mandate any specific behavior, applications MAY
   decide the appropriate semantics themselves.  Also, in practice,
   applications are free to select the proper algorithms when generating
   diff document content.

7.  Usage of Selector Values

   It is up to the application to decide what kind of selector values to
   use.  Positional element selectors like &quot;*/*[3]/*[2]&quot; provide the
   shortest selectors, but care must to taken when using them.  When
   there are several removals of sibling elements, the positional
   element indexes change after each update.  Likewise these indexes
   change when new elements are inserted into the tree.  Using names
   with possible attribute predicates like &quot;doc[@sel=&#39;foo&#39;]&quot; is usually
   easier for an application, be it for example an auto diff tool, but
   it leads to larger diff documents.

8.  XML Schema Types of Patch Operation Elements

</pre><div style='overflow:auto;border:dashed;margin:8px;padding:24px;background-color:#FFFFAF;'><b><i>Technical <a href='https://www.rfc-editor.org/errata/eid3458'>Errata 3458</a> updates this section as follows:</i></b><br/><br/><i><b>Old Text:</b></i><br/><pre style='margin:20px'>


&lt;!ENTITY id     &quot;id\(('&amp;ncname;')?\)|id\((&amp;quot;&amp;ncname;&amp;quot;)?\)&quot;&gt;
</pre><br/><i><b>New Text:</b></i><br/><pre style='margin:20px'>

&lt;!ENTITY id     &quot;id\('&amp;ncname;'\)|id\(&amp;quot;&amp;ncname;&amp;quot;\)&quot;&gt;
</pre><i><b>Errata Notes: </b>

The regex in the XSD suggests that &quot;id()&quot; would be a valid selector for a patch, but it would not make sense to specify such a selector since it never would select a node (there's no identifier to locate in the document). This means that while &quot;id()&quot; is a valid XPath expression, it should not be allowed as a selector expression within an XML patch document.

</i></div><pre>

   The schema types for the patch operation elements.

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;!DOCTYPE schema [
    &lt;!ENTITY ncname &quot;\i\c*&quot;&gt;
    &lt;!ENTITY qname  &quot;(&amp;ncname;:)?&amp;ncname;&quot;&gt;
    &lt;!ENTITY aname  &quot;@&amp;qname;&quot;&gt;
    &lt;!ENTITY pos    &quot;\[\d+\]&quot;&gt;



Urpalainen                  Standards Track                    [Page 19]

RFC 5261                    Patch Operations              September 2008


    &lt;!ENTITY attr   &quot;\[&amp;aname;=&#39;(.)*&#39;\]|\[&amp;aname;=&amp;quot;(.)*&amp;quot;\]&quot;&gt;
    &lt;!ENTITY valueq &quot;\[(&amp;qname;|\.)=&amp;quot;(.)*&amp;quot;\]&quot;&gt;
    &lt;!ENTITY value  &quot;\[(&amp;qname;|\.)=&#39;(.)*&#39;\]|&amp;valueq;&quot;&gt;
    &lt;!ENTITY cond   &quot;&amp;attr;|&amp;value;|&amp;pos;&quot;&gt;
    &lt;!ENTITY step   &quot;(&amp;qname;|\*)(&amp;cond;)*&quot;&gt;
    &lt;!ENTITY piq    &quot;processing-instruction\((&amp;quot;&amp;ncname;&amp;quot;)\)&quot;&gt;
    &lt;!ENTITY pi     &quot;processing-instruction\((&#39;&amp;ncname;&#39;)?\)|&amp;piq;&quot;&gt;
    &lt;!ENTITY id     &quot;id\((&#39;&amp;ncname;&#39;)?\)|id\((&amp;quot;&amp;ncname;&amp;quot;)?\)&quot;&gt;
    &lt;!ENTITY com    &quot;comment\(\)&quot;&gt;
    &lt;!ENTITY text   &quot;text\(\)&quot;&gt;
    &lt;!ENTITY nspa   &quot;namespace::&amp;ncname;&quot;&gt;
    &lt;!ENTITY cnodes &quot;(&amp;text;(&amp;pos;)?)|(&amp;com;(&amp;pos;)?)|((&amp;pi;)(&amp;pos;)?)&quot;&gt;
    &lt;!ENTITY child  &quot;&amp;cnodes;|&amp;step;&quot;&gt;
    &lt;!ENTITY last   &quot;(&amp;child;|&amp;aname;|&amp;nspa;)&quot;&gt;
   ]&gt;
   &lt;xsd:schema
        xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
        elementFormDefault=&quot;qualified&quot;&gt;

    &lt;xsd:simpleType name=&quot;xpath&quot;&gt;
     &lt;xsd:restriction base=&quot;xsd:string&quot;&gt;
      &lt;xsd:pattern
       value=&quot;(/)?((&amp;id;)((/&amp;step;)*(/&amp;last;))?|(&amp;step;/)*(&amp;last;))&quot;/&gt;
     &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:simpleType name=&quot;xpath-add&quot;&gt;
     &lt;xsd:restriction base=&quot;xsd:string&quot;&gt;
      &lt;xsd:pattern
       value=&quot;(/)?((&amp;id;)((/&amp;step;)*(/&amp;child;))?|(&amp;step;/)*(&amp;child;))&quot;/&gt;
     &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:simpleType name=&quot;pos&quot;&gt;
     &lt;xsd:restriction base=&quot;xsd:string&quot;&gt;
      &lt;xsd:enumeration value=&quot;before&quot;/&gt;
      &lt;xsd:enumeration value=&quot;after&quot;/&gt;
      &lt;xsd:enumeration value=&quot;prepend&quot;/&gt;
     &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:simpleType name=&quot;type&quot;&gt;
     &lt;xsd:restriction base=&quot;xsd:string&quot;&gt;
      &lt;xsd:pattern value=&quot;&amp;aname;|&amp;nspa;&quot;/&gt;
     &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:complexType name=&quot;add&quot;&gt;



Urpalainen                  Standards Track                    [Page 20]

RFC 5261                    Patch Operations              September 2008


     &lt;xsd:complexContent mixed=&quot;true&quot;&gt;
      &lt;xsd:restriction base=&quot;xsd:anyType&quot;&gt;
       &lt;xsd:sequence&gt;
        &lt;xsd:any processContents=&quot;lax&quot; namespace=&quot;##any&quot;
                 minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;/&gt;
       &lt;/xsd:sequence&gt;
       &lt;xsd:attribute name=&quot;sel&quot; type=&quot;xpath-add&quot;
                      use=&quot;required&quot;/&gt;
       &lt;xsd:attribute name=&quot;pos&quot; type=&quot;pos&quot;/&gt;
       &lt;xsd:attribute name=&quot;type&quot; type=&quot;type&quot;/&gt;
      &lt;/xsd:restriction&gt;
     &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;

    &lt;xsd:complexType name=&quot;replace&quot;&gt;
     &lt;xsd:complexContent mixed=&quot;true&quot;&gt;
      &lt;xsd:restriction base=&quot;xsd:anyType&quot;&gt;
       &lt;xsd:sequence&gt;
        &lt;xsd:any processContents=&quot;lax&quot; namespace=&quot;##any&quot;
                 minOccurs=&quot;0&quot; maxOccurs=&quot;1&quot;/&gt;
       &lt;/xsd:sequence&gt;
       &lt;xsd:attribute name=&quot;sel&quot; type=&quot;xpath&quot; use=&quot;required&quot;/&gt;
      &lt;/xsd:restriction&gt;
     &lt;/xsd:complexContent&gt;
    &lt;/xsd:complexType&gt;

    &lt;xsd:simpleType name=&quot;ws&quot;&gt;
     &lt;xsd:restriction base=&quot;xsd:string&quot;&gt;
      &lt;xsd:enumeration value=&quot;before&quot;/&gt;
      &lt;xsd:enumeration value=&quot;after&quot;/&gt;
      &lt;xsd:enumeration value=&quot;both&quot;/&gt;
     &lt;/xsd:restriction&gt;
    &lt;/xsd:simpleType&gt;

    &lt;xsd:complexType name=&quot;remove&quot;&gt;
     &lt;xsd:attribute name=&quot;sel&quot; type=&quot;xpath&quot; use=&quot;required&quot;/&gt;
     &lt;xsd:attribute name=&quot;ws&quot; type=&quot;ws&quot;/&gt;
    &lt;/xsd:complexType&gt;

   &lt;/xsd:schema&gt;

9.  XML Schema of Patch Operation Errors

   The patch operation errors definitions.

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;xsd:schema
       targetNamespace=&quot;urn:ietf:params:xml:ns:patch-ops-error&quot;



Urpalainen                  Standards Track                    [Page 21]

RFC 5261                    Patch Operations              September 2008


       xmlns:tns=&quot;urn:ietf:params:xml:ns:patch-ops-error&quot;
       xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;
       elementFormDefault=&quot;qualified&quot;
       attributeFormDefault=&quot;unqualified&quot;&gt;

    &lt;!-- This import brings in the XML language attribute xml:lang--&gt;
    &lt;xsd:import namespace=&quot;http://www.w3.org/XML/1998/namespace&quot;
                schemaLocation=&quot;http://www.w3.org/2001/xml.xsd&quot;/&gt;

    &lt;!-- ROOT document element for signaling patch-ops errors --&gt;
    &lt;xsd:element name=&quot;patch-ops-error&quot;&gt;
     &lt;xsd:complexType&gt;
      &lt;xsd:sequence&gt;
       &lt;xsd:any namespace=&quot;##any&quot; processContents=&quot;lax&quot;
                minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;/&gt;
      &lt;/xsd:sequence&gt;
      &lt;xsd:anyAttribute processContents=&quot;lax&quot;/&gt;
     &lt;/xsd:complexType&gt;
    &lt;/xsd:element&gt;

    &lt;!-- patch-ops error elements:
         not intended to be used as root documnet elements --&gt;
    &lt;xsd:element name=&quot;invalid-attribute-value&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-character-set&quot;
                 type=&quot;tns:patch-error-simple&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-diff-format&quot;
                 type=&quot;tns:patch-error-simple&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-entity-declaration&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-namespace-prefix&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-namespace-uri&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-node-types&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-patch-directive&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-root-element-operation&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-xml-prolog-operation&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;invalid-whitespace-directive&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;unlocated-node&quot;
                 type=&quot;tns:patch-error&quot;/&gt;
    &lt;xsd:element name=&quot;unsupported-id-function&quot;
                 type=&quot;tns:patch-error&quot;/&gt;



Urpalainen                  Standards Track                    [Page 22]

RFC 5261                    Patch Operations              September 2008


    &lt;xsd:element name=&quot;unsupported-xml-id&quot;
                 type=&quot;tns:patch-error&quot;/&gt;

    &lt;!-- simple patch-ops error type  --&gt;
    &lt;xsd:complexType name=&quot;patch-error-simple&quot;&gt;
     &lt;xsd:attribute name=&quot;phrase&quot; type=&quot;xsd:string&quot;/&gt;
     &lt;xsd:attribute ref=&quot;xml:lang&quot;/&gt;
     &lt;xsd:anyAttribute processContents=&quot;lax&quot;/&gt;
    &lt;/xsd:complexType&gt;

    &lt;!-- error type which includes patch operation --&gt;
    &lt;xsd:complexType name=&quot;patch-error&quot;&gt;
     &lt;xsd:sequence&gt;
      &lt;xsd:any namespace=&quot;##any&quot; processContents=&quot;lax&quot;/&gt;
     &lt;/xsd:sequence&gt;
     &lt;xsd:attribute name=&quot;phrase&quot; type=&quot;xsd:string&quot;/&gt;
     &lt;xsd:attribute ref=&quot;xml:lang&quot;/&gt;
     &lt;xsd:anyAttribute processContents=&quot;lax&quot;/&gt;
    &lt;/xsd:complexType&gt;

   &lt;/xsd:schema&gt;

10.  IANA Considerations

   IANA has completed the following actions:

   o  registered a new XML namespace URN according to the procedures of
      RFC 3688 [RFC3688].

   o  registered a new MIME type &#39;application/patch-ops-error+xml&#39;
      according to the procedures of RFC 4288 [RFC4288] and guidelines
      in RFC 3023 [RFC3023].

   o  registered two XML Schemas according to the procedures of RFC 3688
      [RFC3688].

10.1.  URN Sub-Namespace Registration

   This specification registers a new XML namespace, as per the
   guidelines in RFC 3688 [RFC3688].

   URI:  The URI for this namespace is
      urn:ietf:params:xml:ns:patch-ops-error

   Registrant Contact:  IETF, SIMPLE working group, (simple@ietf.org),
      Jari Urpalainen (jari.urpalainen@nokia.com).





Urpalainen                  Standards Track                    [Page 23]

RFC 5261                    Patch Operations              September 2008


   XML:

   BEGIN
   &lt;?xml version=&quot;1.0&quot;?&gt;
   &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML Basic 1.0//EN&quot;
     &quot;http://www.w3.org/TR/xhtml-basic/xhtml-basic10.dtd&quot;&gt;
   &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
   &lt;head&gt;
     &lt;meta http-equiv=&quot;content-type&quot;
        content=&quot;text/html;charset=iso-8859-1&quot;/&gt;
     &lt;title&gt;Patch-Ops Error Namespace&lt;/title&gt;
   &lt;/head&gt;
   &lt;body&gt;
     &lt;h1&gt;Namespace for Patch-Ops Error Documents&lt;/h1&gt;
     &lt;h2&gt;urn:ietf:params:xml:ns:patch-ops-error&lt;/h2&gt;
     &lt;p&gt;See &lt;a
     href=&quot;http://www.rfc-editor.org/rfc/rfc5261.txt&quot;&gt;RFC5261&lt;/a&gt;.&lt;/p&gt;
   &lt;/body&gt;
   &lt;/html&gt;
   END

10.2.  application/patch-ops-error+xml MIME Type

   MIME media type name:  application

   MIME subtype name:  patch-ops-error+xml

   Mandatory parameters:  none

   Optional parameters:  Same as charset parameter application/xml as
      specified in RFC 3023 [RFC3023].

   Encoding considerations:  Same as encoding considerations of
      application/xml as specified in RFC 3023 [RFC3023].

   Security considerations:  See Section 10 of RFC 3023 [RFC3023].

   Interoperability considerations:  none.

   Published specification:  RFC 5261











Urpalainen                  Standards Track                    [Page 24]

RFC 5261                    Patch Operations              September 2008


   Applications which use this media type:  This document type has been
      used to support transport of Patch-Ops errors in RFC 5261.

   Additional Information:

      Magic Number:  None

      File Extension:  .xer

      Macintosh file type code:  &quot;TEXT&quot;

      Personal and email address for further information:  Jari
         Urpalainen, jari.urpalainen@nokia.com

      Intended usage:  COMMON

      Author/Change controller:  The IETF

10.3.  Patch-Ops-Types XML Schema Registration

   This section registers a new XML Schema, the sole content of which is
   shown in Section 8.

      URI:
      urn:ietf:params:xml:schema:patch-ops

      Registrant Contact:
      IETF, SIMPLE working group, &lt;simple@ietf.org&gt;
      Jari Urpalainen, &lt;jari.urpalainen@nokia.com&gt;

10.4.  Patch-Ops-Error XML Schema Registration

   This section registers a new XML Schema, the sole content of which is
   shown in Section 9.

      URI:
      urn:ietf:params:xml:schema:patch-ops-error

      Registrant Contact:
      IETF, SIMPLE working group, &lt;simple@ietf.org&gt;
      Jari Urpalainen, &lt;jari.urpalainen@nokia.com&gt;










Urpalainen                  Standards Track                    [Page 25]

RFC 5261                    Patch Operations              September 2008


11.  Security Considerations

   Security considerations depend very much on the application that
   utilizes this framework.  Since each application will have different
   needs, threat models, and security features, it will be necessary to
   consider these on an application-by-application basis.

   However, this framework utilizes a limited subset of XPath 1.0.
   Applications may thus be vulnerable to XPath injection attacks that
   can reveal some non-allowable content of an XML document.  Injection
   attacks are most likely with shareable resources where access to a
   resource is limited to only some specific parts for a user, contrary
   to a typical use case of this framework.  To defend against those
   attacks the input MUST be sanitized which can be done, for example,
   by validating the diff formats with these restrictive schemas.

12.  Acknowledgments

   The author would like to thank Lisa Dusseault for her efforts
   including BoF arrangements, comments and editing assistance.  The
   author would also like to thank Eva Leppanen, Mikko Lonnfors, Aki
   Niemi, Jonathan Rosenberg, Miguel A. Garcia, Anat Angel, Stephane
   Bortzmeyer, Dave Crocker, Joel Halpern, Jeffrey Hutzelman, David
   Ward, and Chris Newman for their valuable comments and Ted Hardie for
   his input and support.

13.  References

13.1.  Normative References

   [RFC2119]  Bradner, S., &quot;Key words for use in RFCs to Indicate
              Requirement Levels&quot;, BCP 14, RFC 2119, March 1997.

   [W3C.REC-xml-20060816]
              Maler, E., Paoli, J., Bray, T., Yergeau, F., and C.
              Sperberg-McQueen, &quot;Extensible Markup Language (XML) 1.0
              (Fourth Edition)&quot;, World Wide Web Consortium
              Recommendation REC-xml-20060816, August 2006,
              &lt;http://www.w3.org/TR/2006/REC-xml-20060816&gt;.

   [W3C.REC-xpath-19991116]
              DeRose, S. and J. Clark, &quot;XML Path Language (XPath)
              Version 1.0&quot;, World Wide Web Consortium Recommendation
              REC-xpath-19991116, November 1999,
              &lt;http://www.w3.org/TR/1999/REC-xpath-19991116&gt;.






Urpalainen                  Standards Track                    [Page 26]

RFC 5261                    Patch Operations              September 2008


   [W3C.REC-xml-names-20060816]
              Hollander, D., Bray, T., Layman, A., and R. Tobin,
              &quot;Namespaces in XML 1.0 (Second Edition)&quot;, World Wide Web
              Consortium Recommendation REC-xml-names-20060816, August
              2006,
              &lt;http://www.w3.org/TR/2006/REC-xml-names-20060816&gt;.

   [W3C.REC-xmlschema-1-20041028]
              Beech, D., Thompson, H., Maloney, M., and N. Mendelsohn,
              &quot;XML Schema Part 1: Structures Second Edition&quot;, World Wide
              Web Consortium Recommendation REC-xmlschema-1-20041028,
              October 2004,
              &lt;http://www.w3.org/TR/2004/REC-xmlschema-1-20041028&gt;.

   [W3C.REC-xml-c14n-20010315]
              Boyer, J., &quot;Canonical XML Version 1.0&quot;, World Wide Web
              Consortium Recommendation REC-xml-c14n-20010315, March
              2001,
              &lt;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&gt;.

   [W3C.REC-xmlschema-2-20041028]
              Malhotra, A. and P. Biron, &quot;XML Schema Part 2: Datatypes
              Second Edition&quot;, World Wide Web Consortium Recommendation
              REC-xmlschema-2-20041028, October 2004,
              &lt;http://www.w3.org/TR/2004/REC-xmlschema-2-20041028&gt;.

   [W3C.WD-xml-id-20041109]
              Veillard, D., Walsh, N., and J. Marsh, &quot;xml:id Version
              1.0&quot;, W3C LastCall WD-xml-id-20041109, November 2004.

   [RFC3629]  Yergeau, F., &quot;UTF-8, a transformation format of ISO
              10646&quot;, STD 63, RFC 3629, November 2003.

   [RFC3023]  Murata, M., St. Laurent, S., and D. Kohn, &quot;XML Media
              Types&quot;, RFC 3023, January 2001.

   [RFC3688]  Mealling, M., &quot;The IETF XML Registry&quot;, BCP 81, RFC 3688,
              January 2004.

   [RFC4288]  Freed, N. and J. Klensin, &quot;Media Type Specifications and
              Registration Procedures&quot;, BCP 13, RFC 4288, December 2005.










Urpalainen                  Standards Track                    [Page 27]

RFC 5261                    Patch Operations              September 2008


13.2.  Informative References

   [W3C.REC-xpath20-20070123]
              Berglund, A., Fernandez, M., Chamberlin, D., Boag, S.,
              Robie, J., Kay, M., and J. Simeon, &quot;XML Path Language
              (XPath) 2.0&quot;, World Wide Web Consortium Recommendation
              REC-xpath20-20070123, January 2007,
              &lt;http://www.w3.org/TR/2007/REC-xpath20-20070123&gt;.

   [RFC4825]  Rosenberg, J., &quot;The Extensible Markup Language (XML)
              Configuration Access Protocol (XCAP)&quot;, RFC 4825, May 2007.

   [RFC3265]  Roach, A., &quot;Session Initiation Protocol (SIP)-Specific
              Event Notification&quot;, RFC 3265, June 2002.

   [RFC5262]  Lonnfors, M., Leppanen, E., Khartabil, H., and J.
              Urpalainen, &quot;Presence Information Data format (PIDF)
              Extension for Partial Presence&quot;, RFC 5262, September 2008.

   [SIMPLE-XCAP]
              Urpalainen, J. and J. Rosenberg, &quot;An Extensible Markup
              Language (XML) Document Format for Indicating A Change in
              XML Configuration Access Protocol (XCAP) Resources&quot;, Work
              in Progress, May 2008.

   [RFC3903]  Niemi, A., Ed., &quot;Session Initiation Protocol (SIP)
              Extension for Event State Publication&quot;, RFC 3903, October
              2004.























Urpalainen                  Standards Track                    [Page 28]

RFC 5261                    Patch Operations              September 2008


Appendix A.  Informative Examples

   All following examples assume an imaginary XML diff document
   including these patch operation elements.

A.1.  Adding an Element

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;add sel=&quot;doc&quot;&gt;&lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/add&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

A.2.  Adding an Attribute

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;add sel=&quot;doc/foo[@id=&#39;ert4773&#39;]&quot; type=&quot;@user&quot;&gt;Bob&lt;/add&gt;
   &lt;/diff&gt;








Urpalainen                  Standards Track                    [Page 29]

RFC 5261                    Patch Operations              September 2008


   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;foo id=&quot;ert4773&quot; user=&quot;Bob&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

A.3.  Adding a Prefixed Namespace Declaration

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;add sel=&quot;doc&quot; type=&quot;namespace::pref&quot;&gt;urn:ns:xxx&lt;/add&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns:pref=&quot;urn:ns:xxx&quot;&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

A.4.  Adding a Comment Node with the &#39;pos&#39; Attribute

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

   An XML diff document:

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;diff&gt;
  &lt;add sel=&quot;doc/foo[@id=&#39;ert4773&#39;]&quot; pos=&quot;before&quot;&gt;&lt;!-- comment --&gt;&lt;/add&gt;
&lt;/diff&gt;






Urpalainen                  Standards Track                    [Page 30]

RFC 5261                    Patch Operations              September 2008


   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;!-- comment --&gt;&lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

A.5.  Adding Multiple Nodes

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;add sel=&quot;doc&quot;&gt;
     &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/add&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;

     &lt;foo id=&quot;ert4773&quot;&gt;This is a new child&lt;/foo&gt;&lt;/doc&gt;

A.6.  Replacing an Element

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;replace sel=&quot;doc/foo[@a=&#39;1&#39;]&quot;&gt;&lt;bar a=&quot;2&quot;/&gt;&lt;/replace&gt;
   &lt;/diff&gt;




Urpalainen                  Standards Track                    [Page 31]

RFC 5261                    Patch Operations              September 2008


   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;bar a=&quot;2&quot;/&gt;
   &lt;/doc&gt;

A.7.  Replacing an Attribute Value

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc a=&quot;test&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;replace sel=&quot;doc/@a&quot;&gt;new value&lt;/replace&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc a=&quot;new value&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

A.8.  Replacing a Namespace Declaration URI

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns:pref=&quot;urn:test&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;replace sel=&quot;doc/namespace::pref&quot;&gt;urn:new:xxx&lt;/replace&gt;
   &lt;/diff&gt;






Urpalainen                  Standards Track                    [Page 32]

RFC 5261                    Patch Operations              September 2008


   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns:pref=&quot;urn:new:xxx&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

A.9.  Replacing a Comment Node

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns:pref=&quot;urn:test&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;!-- comment --&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;replace sel=&quot;doc/comment()[1]&quot;&gt;&lt;!-- This is the new content
      --&gt;&lt;/replace&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns:pref=&quot;urn:test&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;!-- This is the new content
      --&gt;
   &lt;/doc&gt;

A.10.  Replacing a Processing Instruction Node

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;?test foo=&quot;bar&quot;?&gt;
   &lt;/doc&gt;








Urpalainen                  Standards Track                    [Page 33]

RFC 5261                    Patch Operations              September 2008


   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;replace sel=&#39;doc/processing-instruction(&quot;test&quot;)&#39;
       &gt;&lt;?test bar=&quot;foobar&quot;?&gt;&lt;/replace&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;?test bar=&quot;foobar&quot;?&gt;
   &lt;/doc&gt;

A.11.  Replacing a Text Node

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
    &lt;replace sel=&quot;doc/foo/text()[1]&quot;
      &gt;This is the new text content&lt;/replace&gt;&lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is the new text content&lt;/foo&gt;
   &lt;/doc&gt;

A.12.  Removing an Element

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;




Urpalainen                  Standards Track                    [Page 34]

RFC 5261                    Patch Operations              September 2008


   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
    &lt;remove sel=&quot;doc/foo[@a=&#39;1&#39;]&quot; ws=&quot;after&quot;/&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;/doc&gt;

A.13.  Removing an Attribute

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc a=&quot;foo&quot;&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
    &lt;remove sel=&quot;doc/@a&quot;/&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

A.14.  Removing a Prefixed Namespace Declaration

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot; xmlns:pref=&quot;urn:test&quot;
      &gt;This is a sample document&lt;/foo&gt;
     &lt;!-- comment --&gt;
   &lt;/doc&gt;





Urpalainen                  Standards Track                    [Page 35]

RFC 5261                    Patch Operations              September 2008


   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;remove sel=&quot;doc/foo/namespace::pref&quot;/&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;!-- comment --&gt;
   &lt;/doc&gt;

A.15.  Removing a Comment Node

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;!-- comment --&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;remove sel=&quot;doc/comment()[1]&quot; ws=&quot;after&quot;/&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;/doc&gt;

A.16.  Removing a Processing Instruction Node

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
     &lt;?test?&gt;
   &lt;/doc&gt;



Urpalainen                  Standards Track                    [Page 36]

RFC 5261                    Patch Operations              September 2008


   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;remove sel=&#39;doc/processing-instruction(&quot;test&quot;)&#39;/&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

A.17.  Removing a Text Node

   An example target XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;&gt;This is a sample document&lt;/foo&gt;
   &lt;/doc&gt;

   An XML diff document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;diff&gt;
     &lt;remove sel=&quot;doc/foo/text()[1]&quot;/&gt;
   &lt;/diff&gt;

   A result XML document:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc&gt;
     &lt;foo a=&quot;1&quot;/&gt;
   &lt;/doc&gt;















Urpalainen                  Standards Track                    [Page 37]

RFC 5261                    Patch Operations              September 2008


A.18.  Several Patches With Namespace Mangling

   An example target XML document where namespace qualified elements
   exist:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns=&quot;urn:ietf:params:xml:ns:xxx&quot;
        xmlns:z=&quot;urn:ietf:params:xml:ns:yyy&quot;&gt;
     &lt;note&gt;This is a sample document&lt;/note&gt;
     &lt;elem a=&quot;foo&quot;&gt;
       &lt;child/&gt;
     &lt;/elem&gt;
     &lt;elem a=&quot;bar&quot;&gt;
       &lt;z:child/&gt;
     &lt;/elem&gt;
   &lt;/doc&gt;

   An imaginary XML diff document where prefix &quot;p&quot; corresponds the
   targetNamespace of this imaginary schema:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;p:diff xmlns=&quot;urn:ietf:params:xml:ns:xxx&quot;
           xmlns:y=&quot;urn:ietf:params:xml:ns:yyy&quot;
           xmlns:p=&quot;urn:ietf:params:xml:ns:diff&quot;&gt;

   &lt;p:add sel=&quot;doc/elem[@a=&#39;foo&#39;]&quot;&gt;  &lt;!-- This is a new child --&gt;
       &lt;child id=&quot;ert4773&quot;&gt;
         &lt;y:node/&gt;
       &lt;/child&gt;
     &lt;/p:add&gt;

   &lt;p:replace sel=&quot;doc/note/text()&quot;&gt;Patched doc&lt;/p:replace&gt;

   &lt;p:remove sel=&quot;*/elem[@a=&#39;bar&#39;]/y:child&quot; ws=&quot;both&quot;/&gt;

   &lt;p:add sel=&quot;*/elem[@a=&#39;bar&#39;]&quot; type=&quot;@b&quot;&gt;new attr&lt;/p:add&gt;

   &lt;/p:diff&gt;













Urpalainen                  Standards Track                    [Page 38]

RFC 5261                    Patch Operations              September 2008


   One possible form of the result XML document after applying the
   patches:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;doc xmlns=&quot;urn:ietf:params:xml:ns:xxx&quot;
        xmlns:z=&quot;urn:ietf:params:xml:ns:yyy&quot;&gt;
     &lt;note&gt;Patched doc&lt;/note&gt;
     &lt;elem a=&quot;foo&quot;&gt;
       &lt;child/&gt;
       &lt;!-- This is a new child --&gt;
       &lt;child id=&quot;ert4773&quot;&gt;
         &lt;z:node/&gt;
       &lt;/child&gt;
     &lt;/elem&gt;
     &lt;elem a=&quot;bar&quot; b=&quot;new attr&quot;/&gt;
   &lt;/doc&gt;

   The &lt;node&gt; and removed &lt;child&gt; element prefixes within the XML diff
   document are different than what are the &quot;identical&quot; namespace
   declarations in the target XML document.  If the target XML document
   had used a prefixed namespace declaration instead of the default one,
   the XML diff document could still have been the same.  The added new
   qualified elements would just have inherited that prefix.

Author&#39;s Address

   Jari Urpalainen
   Nokia
   Itamerenkatu 11-13
   Helsinki  00180
   Finland

   Phone: +358 7180 37686
   EMail: jari.urpalainen@nokia.com

















Urpalainen                  Standards Track                    [Page 39]

RFC 5261                    Patch Operations              September 2008


Full Copyright Statement

   Copyright (C) The IETF Trust (2008).

   This document is subject to the rights, licenses and restrictions
   contained in BCP 78, and except as set forth therein, the authors
   retain all their rights.

   This document and the information contained herein are provided on an
   &quot;AS IS&quot; basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
   OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY, THE IETF TRUST AND
   THE INTERNET ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS
   OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF
   THE INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the procedures with respect to rights in RFC documents can be
   found in BCP 78 and BCP 79.

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   http://www.ietf.org/ipr.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at
   ietf-ipr@ietf.org.












Urpalainen                  Standards Track                    [Page 40]

</pre>