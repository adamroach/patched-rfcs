<pre>






Network Working Group                                       H. Khartabil
Request for Comments: 4660                                         Telio
Category: Standards Track                                    E. Leppanen
                                                             M. Lonnfors
                                                        J. Costa-Requena
                                                                   Nokia
                                                          September 2006


         Functional Description of Event Notification Filtering

Status of This Memo

   This document specifies an Internet standards track protocol for the
   Internet community, and requests discussion and suggestions for
   improvements.  Please refer to the current edition of the &quot;Internet
   Official Protocol Standards&quot; (STD 1) for the standardization state
   and status of this protocol.  Distribution of this memo is unlimited.

Copyright Notice

   Copyright (C) The Internet Society (2006).

Abstract

   The SIP event notification framework describes the usage of the
   Session Initiation Protocol (SIP) for subscriptions and notifications
   of changes to the state of a resource.  The document does not
   describe a mechanism whereby filtering of event notification
   information can be achieved.

   This document describes the operations a subscriber performs in order
   to put filtering rules associated with a subscription to event
   notification information in place.  The handling, by the subscriber,
   of responses to subscriptions carrying filtering rules and the
   handling of notifications with filtering rules applied to them are
   also described.  Furthermore, the document conveys how the notifier
   behaves when receiving such filtering rules and how a notification is
   constructed.












Khartabil, et al.           Standards Track                     [Page 1]

RFC 4660          Functional Description of Filtering     September 2006


Table of Contents

   1. Introduction ....................................................3
   2. Conventions .....................................................3
   3. Client Operation ................................................4
      3.1. Transport Mechanism ........................................4
      3.2. SUBSCRIBE Bodies ...........................................4
      3.3. Subscriber Generating of SUBSCRIBE Requests ................4
           3.3.1. Defining the Filtering Rules ........................4
           3.3.2. Request-URI vs. Filter URI ..........................5
           3.3.3. Changing Filters within a Dialog ....................5
           3.3.4. Subscriber Interpreting of SIP Responses ............6
      3.4. Subscriber Processing of NOTIFY Requests ...................6
   4. Resource List Server Behaviour ..................................7
      4.1. Request-URI vs. Filter URI .................................7
      4.2. Changing Filters within a Dialog ...........................9
   5. Server Operation ................................................9
      5.1. NOTIFY Bodies ..............................................9
      5.2. Notifier Processing of SUBSCRIBE Requests ..................9
           5.2.1. Request-URI vs. Filter URI .........................10
           5.2.2. Changing Filters within a Dialog ...................11
      5.3. Notifier Generating of NOTIFY Requests ....................11
           5.3.1. Generation of NOTIFY Contents ......................12
           5.3.2. Handling of Notification Triggering Rules ..........13
      5.4. Handling Abnormal Cases ...................................13
   6. XML Document Validation ........................................14
   7. Examples .......................................................14
      7.1. Presence Specific Examples ................................14
           7.1.1. Subscriber Requests Messaging-Related Information ..15
           7.1.2. Subscriber Fetches Information about &quot;Open&quot;
                  Communication Means ................................16
           7.1.3. Subscriber Requests Notifications When
                  Presentity&#39;s Status Changes ........................18
      7.2. Watcher Information Specific Examples .....................21
           7.2.1. Watcher Subscriber Makes Subscription to
                  Get All the Information about Active Watchers ......22
           7.2.2. Watcher Subscriber Requests Information of
                  Watchers with Specific Subscription Duration
                  Conditions .........................................23
           7.2.3. Watcher Subscriber Requests Specific
                  Watcher Info on Specific Triggers ..................24
   8. Security Considerations ........................................27
   9. IANA Considerations ............................................28
   10. Acknowledgements ..............................................28
   11. References ....................................................28
      11.1. Normative References .....................................28
      11.2. Informative References ...................................28




Khartabil, et al.           Standards Track                     [Page 2]

RFC 4660          Functional Description of Filtering     September 2006


1.  Introduction

   SIP event notification is described in [3].  It defines a general
   framework for sending subscriptions and receiving notifications in
   SIP-based systems.  It introduces the concept of event packages,
   which are concrete applications of the general event framework to a
   specific usage of events.

   Filtering is a mechanism for controlling the content of event
   notifications.  Additionally, the subscriber may specify the rules
   for when a notification should be sent to it.  The filtering
   mechanism is expected to be particularly valuable to users of mobile
   wireless access devices.  The characteristics of the devices
   typically include high latency, low bandwidth, low data processing
   capabilities, small display, and limited battery power.  Such devices
   can benefit from the ability to filter the amount of information
   generated at the source of the event notification.  However,
   implementers need to be aware of the computational burden on the
   source of the event notification.  This is discussed further in
   Section 8.

   It is stated in [3] that the notifier may send a NOTIFY at any time,
   but typically it is sent when the state of the resource changes.  It
   also states that the notifications would contain the complete and
   current state of the resource authorized for a certain subscriber to
   see.  The format of such resource state information is package
   specific.  In this memo, we assume that the NOTIFY for any package
   contains an XML document.

   This document, together with [5], presents a mechanism for filtering
   whereby a subscriber describes its preference of when notifications
   are to be sent to it and what they are to contain.  It also describes
   how the notifier functions when generating notifications by taking
   into account filters and default functionality of the package/
   service.

   The XML format for defining the filter is described in [5].

2.  Conventions

   In this document, the key words &#39;MUST&#39;, &#39;MUST NOT&#39;, &#39;REQUIRED&#39;,
   &#39;SHALL&#39;, &#39;SHALL NOT&#39;, &#39;SHOULD&#39;, &#39;SHOULD NOT&#39;, &#39;RECOMMENDED&#39;, &#39;MAY&#39;,
   and &#39;OPTIONAL&#39; are to be interpreted as described in RFC 2119 [1] and
   indicate requirement levels for compliant implementations.

   &quot;Content&quot; refers to the XML document that appears in a notification
   reflecting the state of a resource.




Khartabil, et al.           Standards Track                     [Page 3]

RFC 4660          Functional Description of Filtering     September 2006


3.  Client Operation

3.1.  Transport Mechanism

   Transportation of the filter to the server is achieved by inserting
   the XML document, as defined in [5], in the body of the SUBSCRIBE
   request.  Alternatively, the XML document can be uploaded to the
   server using means outside the scope of this document.

3.2.  SUBSCRIBE Bodies

   SIP entities compliant with this specification MUST support the
   content type &#39;application/simple-filter+xml&#39;.

3.3.  Subscriber Generating of SUBSCRIBE Requests

   This section presents additional functionality required from the
   subscriber when filters are used in the bodies of the SUBSCRIBE
   requests.  Normal operations of services (e.g., as defined in [8],
   [10], and [4]) are otherwise followed.

   As defined in [3], the SUBSCRIBE message MAY contain a body.  This
   body would carry filtering information.  Honouring those filters is
   at the discretion of the notifier and might depend on local policies.

   No content in the body of a SUBSCRIBE indicates to the notifier that
   no filter is being requested, so the notifier is instructed to send
   all the NOTIFY requests using the notifier&#39;s own or service-specific
   policy.  Note that, for example, in the list case [4], the filter
   might have been uploaded to the server beforehand (by means outside
   the scope of this document).

   If the body of the SUBSCRIBE includes the filter, the body MUST be of
   the MIME-Type &#39;application/simple-filter+xml&#39;.

3.3.1.  Defining the Filtering Rules

</pre><div style='overflow:auto;border:dashed;margin:8px;padding:24px;background-color:#FFFFAF;'><b><i>Editorial <a href='https://www.rfc-editor.org/errata/eid921'>Errata 921</a> updates this section as follows:</i></b><br/><pre style='margin:20px'>
(1) [[posted separately.]]

(2)  general issue: presentation/formatting of XML text

Although it carries no functional relevance, uniform formatting
and consistent indentation of XML text significantly adds to
the readability and furthers the understanding of the structure.
Unfortunately, there are many places in the two RFCs where --
perhaps as a result of the use of various tools in the publication
process -- non-uniform and inconsistent indentation in XML text
impedes the readability of the XML schemata and the XML examples.

At a minimum, pairing opening and closing XML tags, if on different
lines, should be indented by the same amount of white space,
and XML elements on the same hierarchical level (within another
XML element) should be indented equally.

For brevity of this message, I omit detailing the numerous places
affected I have marked in my printed copies of the two RFCs.


(3)  repeated word replications and grammar  (RFC 4660)

The second paragraph of Section 3.3.1 of RFC 4660, at the bottom
of page 3, says:

   A SUBSCRIBE request destined to a list URI [4] MAY include multiple
   filters specific to individual resources.  This is achieved by
   including multiple &lt;filter&gt; elements with different URIs of resources
|  in each of those elements.  This resource specific resource-specific
|  filter are processed first before any list specific list-specific
|  filter, if any.  The list specific list-specific filter may or may
   not include a URI.

It should perhaps say:

   A SUBSCRIBE request destined to a list URI [4] MAY include multiple
   filters specific to individual resources.  This is achieved by
   including multiple &lt;filter&gt; elements with different URIs of resources
|  in each of those elements.  This resource-specific filter is
|  processed first, before any list-specific filter, if any.  The
|  list-specific filter may or may not include a URI.


(4)  distorting extra blank line   (RFC4660)

The example scenario description in Section 4.1 of RFC 4660,
on top of page 8, are made less comprehensible by the additional
blank line in between:

   List1 (list1@example.com) on RLS1 has: bob@example.com

   list2@biloxi.com

Should perhaps better say:

   List1 (list1@example.com) on RLS1 has: bob@example.com
   list2@biloxi.com

or even better:

   List1 (list1@example.com) on RLS1 has:
     bob@example.com list2@biloxi.com


(5)  inappropriate Section headlines   (RFC4660)

The ToC and the body of RFC 4660 (on page 9) contains the Section
headlines:

 5.  Server Operation

 5.1.  NOTIFY Bodies

should better say:

 5.  Notifier Operation

 5.1   SUBSCRIBE Bodies

Rationale:

Obviously, these titles are inappropriate.

a) The document deals with two kinds of 'server' roles:
     *  Resource List Server (RLS),  and
     *  SIP servers in the Notifier role
   Since Section 4 deals with RLS behaviour (and does tell so
   in its headline), and Section 5 deals with Notifier behaviour,
   the latter should tell so as well, and not pretend to be
   applicable to server operation in general.

b) NOTIFY bodies/content are dealt with in Section 5.3 ff.
   As can be seen immediately, Section 5.1 talks about
   SUBSCRIBE bodies.


(6)  typo/grammar  (RFC 4660)

Within Section 5.2.1, at the bottom of page 10, RFC 4660 says:

                                 [...].  Notifiers belonging to the
|  domain MUST apply the filter to all notifications it sends for that
   subscription, unless policy dictates otherwise.
                                                     ^^^^^^^^
It should say:

                                 [...].  Notifiers belonging to the
|  domain MUST apply the filter to all notifications they send for that
   subscription, unless policy dictates otherwise.
                                                     ^^^^^^^^^


(7)  placement of text ??   (RFC 4660)

The first paragraph of Section 5.3, on page 11,

   Upon receiving the SUBSCRIBE with the filter, the notifier SHOULD
   retain the filter as long as the subscription persists.  The filter
   MAY be incorporated within an existing subscription (in an active
   dialog) by sending a re-SUBSCRIBE that includes the filter in the
   body.

apparently should have been moved up to the end of Section 5.2
because it is related to behaviour during
   &quot;Notifier Processing of SUBSCRIBE Requests&quot; == Section 5.2


(8)  improper use of articles  (RFC 4660)

There are two related issues with text in the 2nd and 3rd paragraph
of Section 5.3, on mid-page 11:

   If the response sent to the SUBSCRIBE was a &quot;202&quot; and the &quot;202&quot; was
|  chosen because the filter could not be accepted that time, the NOTIFY
   MAY be used to terminate the subscription if the filter is found
   unacceptable.

|  As described in [3], the NOTIFY message MAY contain a body that
   describes the state of the resource.  This body is in one of the
   formats listed in the Accept header field of the SUBSCRIBE, or in the
   package-specific default if the Accept header field is omitted.

The first occurrence of &quot;the NOTIFY&quot; is improper because this is the
first place the text talks about a NOTIFY message in this context.
The definite article should either be omitted entirely, or better
be replaced by &quot;a NOTIFY message&quot;.
The second &quot;the NOTIFY&quot; is improper because it (re-)states a general
property of all NOTIFY messages, not of a specific NOTIFY message.
Therefore, the above text should say:

   If the response sent to the SUBSCRIBE was a &quot;202&quot; and the &quot;202&quot; was
|  chosen because the filter could not be accepted that time, a NOTIFY
   maeeage MAY be used to terminate the subscription if the filter is
   found unacceptable.

|  As described in [3], a NOTIFY message MAY contain a body that
   describes the state of the resource.  This body is in one of the
   formats listed in the Accept header field of the SUBSCRIBE, or in the
   package-specific default if the Accept header field is omitted.


(9)  missing articles  (RFC 4660)

Within Section 7.1.3, near the top of page 20, where RFC 4660 says:

   Notification containing both tuples is sent to the subscriber in this
   case:

it should better say:

|  A Notification containing both tuples is sent to the subscriber in
   this case:

and within Section 7.2.3, in the upper half of page 26, where the RFC
says:

   Notification to the subscriber is created, taking into account the
   &lt;trigger&gt; and &lt;what&gt; elements:

it should better say:

|  A Notification to the subscriber is created, taking into account the
   &lt;trigger&gt; and &lt;what&gt; elements:


Notes:

from pending

</pre></div><pre>

   Multiple filters MAY be included in one SUBSCRIBE.  This is achieved
   by including multiple &lt;filter&gt; elements in the filter [5].  Each
   &lt;filter&gt; element may include a &#39;uri&#39; attribute.

   A SUBSCRIBE request destined to a list URI [4] MAY include multiple
   filters specific to individual resources.  This is achieved by
   including multiple &lt;filter&gt; elements with different URIs of resources
   in each of those elements.  This resource specific resource-specific
   filter are processed first before any list specific list-specific
   filter, if any.  The list specific list-specific filter may or may
   not include a URI.



Khartabil, et al.           Standards Track                     [Page 4]

RFC 4660          Functional Description of Filtering     September 2006


   Furthermore, regardless of whether the SUBSCRIBE is destined to a
   list URI, there can only be one filter applicable to a single
   resource or domain within a single SUBSCRIBE.  That is, each filter
   within a subscription MUST uniquely identify one resource or one
   domain.

   A filter can be enabled and disabled using the &#39;enabled&#39; attribute in
   the &lt;filter&gt; element, as described in [5].

3.3.2.  Request-URI vs. Filter URI

   The URI in the filter defines the target resource.  For example, in
   the Presence service case, it is the presentity&#39;s presence
   information to which the filter is applied.  The subscriber MAY
   choose to leave the URI in the filter undefined.  If the URI is not
   defined within the filter, the filter applies to the resource
   identified in the Request-URI.  Similarly, the subscriber MAY define
   a filter URI.  If the Request-URI is a list URI [4], the filter URI
   MUST be the list URI, a sub-list URI, or resource whose URI is one of
   the URIs that result from a lookup, by a Resource List Server (RLS),
   on the Request-URI.  If it is not, the filter may be ignored or may
   be rejected.  URI matching is done according to the matching rules
   defined for a particular scheme (SIP URI matching rules are defined
   in RFC 3261 [2]).

   A filter may also be addressed to a domain using the &#39;domain&#39;
   attribute instead of the &#39;uri&#39; attribute.  In this case, the filter
   applies to resources in that domain.  This can be used when a
   subscription is for a resource that is an event list with many
   resources from differing domains.  If an individual resource-specific
   filter is present along with the domain filter, this
   resource-specific filter overrides any domain-specific filter, if
   any.

3.3.3.  Changing Filters within a Dialog

   The subscriber MAY reset or change the filter by re-issuing a new
   SUBSCRIBE request within the existing dialog.  A SUBSCRIBE within the
   exiting dialog that does not contain a filter is assumed to maintain
   existing filters.  This means that filters are persistent within a
   dialog and are only explicitly removed.

   A subscriber requiring removal of a filter may do so by using the
   &#39;remove=&quot;true&quot;&#39; attribute, as defined in [5].

   In the case where the URI in the filter is that of a list, a
   subscriber may override the existing filter with a filter for an
   individual resource that is part of the list subscribed to earlier by



Khartabil, et al.           Standards Track                     [Page 5]

RFC 4660          Functional Description of Filtering     September 2006


   issuing a new SUBSCRIBE within the existing dialog and including a
   filter, specific for that individual resource, using a new filter ID.
   The new filter need not include the original filter since a filter is
   only removed in the manner indicated above.

   A filter is replaced by the subscriber re-issuing the filter using
   the same filter ID and replacing the contents of the filter.
   Replacing a filter by changing the filter ID and keeping the resource
   URI is considered an error since this causes the server to assume
   that two filters are placed for the same resource.

   Again, a filter can be disabled and re-enabled using the &#39;enabled&#39;
   attribute in the &lt;filter&gt; element, as described in [5].

3.3.4.  Subscriber Interpreting of SIP Responses

   The SUBSCRIBE request will be confirmed with a final response.  A
   200-class response indicates that the subscription has been accepted
   and that a NOTIFY will be sent immediately.  A &quot;200&quot; response
   indicates that the subscription has been accepted and that the filter
   is accepted.  A &quot;202&quot; response merely indicates that the subscription
   has been understood, that the content type has been accepted, and
   that authorization may or may not have been granted.  A &quot;202&quot;
   response also indicates that the filter has not been accepted yet.
   The acceptance of the filter MAY arrive in a subsequent NOTIFY.

   A non-200 class final response indicates that no subscription or
   dialog has been created, and no subsequent NOTIFY message will be
   sent.  All non-200 class final responses have the same meanings and
   handling as described in [2] and [3].

   Specifically, a &quot;415&quot; response indicates that the MIME type
   &#39;application/simple-filter+xml&#39; is not understood by the notifier.  A
   &quot;488&quot; response indicates that the content type (filter) is understood
   but some aspects of it were either not understood or not accepted.

3.4.  Subscriber Processing of NOTIFY Requests

   If the 2xx response was returned for the SUBSCRIBE, the NOTIFY that
   follows MAY contain a body that describes the present state of the
   resource after the filters have been applied.

   If the NOTIFY indicates that a subscription has been terminated [3],
   the subscription is assumed to be terminated.  Behaviour in such
   events is also described in [3].

   If the subscription is indicated as active, NOTIFY requests are
   handled as described in package-specific documents and in [3].



Khartabil, et al.           Standards Track                     [Page 6]

RFC 4660          Functional Description of Filtering     September 2006


4.  Resource List Server Behaviour

   The Resource List Server is defined in [4].  This section describes
   how such an entity behaves in the presence of a filter in a
   subscription to a list.

4.1.  Request-URI vs. Filter URI

   If the URI is not defined within the filter, the filter applies to
   the resource list identified in the Request-URI of the SUBSCRIBE
   request.  This results in the filters being applied to all the
   notifications that the RLS issues to this subscription.  The same
   processing applies to a filter that defines a URI that matches the
   request-URI of the SUBSCRIBE request.  That is, the filter applies to
   all notifications that the RLS issues to this subscription.

   If the URI indicated by the filter is for one resource whose URI is
   one of the URIs that result from a lookup by the RLS on the
   Request-URI, the filter for that particular resource is extracted and
   propagated in the SUBSCRIBE request sent to that resource.  It is
   possible to have more than one filter in a SUBSCRIBE request body,
   and therefore a filter specific to a resource MUST be extracted and
   only that one is propagated.  For example, if the Request-URI in a
   SUBSCRIBE has the value &quot;sip:mybuddies@example.com&quot;, where
   &quot;bob@example.com&quot; is a resource belonging to that list, and the URI
   in a filter is &quot;sip:bob@example.com&quot;, the filter specific for Bob is
   extracted and placed in the body of the SUBSCRIBE sent to
   &quot;bob@example.com&quot;.

   If the URI indicated by the filter is for one resource whose URI is
   NOT under the RLS administrative control, the RLS propagates the
   filter to all the fanned out subscriptions.  This is to accommodate
   the scenario where the subscriber knows that there are sub-lists in
   the event list that are under a different administrative domain from
   that where the original subscription was sent, and the subscriber
   wishes to set a filter for a resource in that sub-list.

   If the URI indicated by the filter is for one resource whose URI is
   under the RLS administrative control but is not part of the resource
   list that the subscription was addressed to, the filter is not
   propagated.  In this case, it is the RLS&#39;s responsibility to make
   sure that this filter is applied to notifications issued, if
   information about that resource is present.








Khartabil, et al.           Standards Track                     [Page 7]

RFC 4660          Functional Description of Filtering     September 2006


   For example: If we have 2 lists, each located on its own RLS:

   List1 (list1@example.com) on RLS1 has: bob@example.com

   list2@biloxi.com

   List2 on RLS2 has: alice@biloxi.com sarah@example.com
   (Note: list2 is a resource in list1)

   RLS1 receives the following SUBSCRIBE request (the SUBSCRIBE is
   addressed to list1 and contains 2 filters: one for sarah@example.com
   and the other for alice@biloxi.com):

   SUBSCRIBE sip:List1@example.com SIP/2.0
   ...
   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;pidf&quot; urn=&quot;urn:ietf:params:xml:ns:pidf&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;999&quot; uri=&quot;sip:sarah@example.com&quot;&gt;
       &lt;what&gt;
         &lt;include type=&quot;namespace&quot;&gt;
           urn:ietf:params:xml:ns:pidf&lt;/include&gt;
         &lt;exclude&gt;
           //pidf:tuple/pidf:note&lt;/exclude&gt;
       &lt;/what&gt;
     &lt;/filter&gt;
     &lt;filter id=&quot;8439&quot; uri=&quot;sip:alice@biloxi.com&quot;&gt;
       &lt;what&gt;
         &lt;include&gt;
           //pidf:tuple/pidf:status/pidf:basic&lt;/include&gt;
       &lt;/what&gt;
     &lt;/filter&gt;
   &lt;/filter-set&gt;

   RLS1 fans out subscriptions to resources on list1.  The text above
   suggests that if a filter is destined to a resource that is not part
   of the list and is outside the administrative domain of an RLS, then
   that filter is propagated.  The rest are consumed.  In our example,
   only the filter to alice@biloxi.com is propagated since biloxi.com is
   not under the administrative domain of RLS1.  The filter to
   sarah@example.com is consumed, and RLS1 needs to apply that filter to
   notifications it receives.

   URI matching is done according to the matching rules defined for a
   particular scheme (SIP URI matching rules are defined in RFC 3261
   [2]).



Khartabil, et al.           Standards Track                     [Page 8]

RFC 4660          Functional Description of Filtering     September 2006


   A filter may also be addressed to a domain using the &#39;domain&#39;
   attribute instead of the &#39;uri&#39; attribute.  In this case, the filter
   applies to resources in that domain, and the RLS MUST NOT apply
   filters to any notifications it sends.  Instead, it MUST forward the
   filter with all fanned-out subscriptions to the notifiers.

   As indicated in Section 3.3.1, multiple filters can be present in a
   SUBSCRIBE request.  Filters can also be added or modified as
   indicated in Section 3.3.3.  In such circumstances, an RLS MUST check
   that there are no filters addressed to the same resource or domain,
   and if there are, it MUST reject the SUBSCRIBE request with a &quot;488&quot;
   error response.

4.2.  Changing Filters within a Dialog

   If an RLS receives a subscription refresh request with no filters
   specified (empty payload), the RLS assumes that the client does not
   wish to update the filters.  If an RLS receives a subscription
   refresh with a filter containing the &#39;remove=&quot;true&quot;&#39; attribute, as
   defined in [5], the RLS assumes that the client is removing that
   filter identified by the filter ID.

   If an RLS receives a subscription refresh request with a filter that
   already exists (i.e., having the same filter ID), the RLS interprets
   it as a replacement of the existing filter.  Replacing a filter by
   changing the filter ID and keeping the resource URI is considered an
   error since this causes the RLS to assume that two filters are in
   place for the same resource.

   A filter can be disabled and re-enabled using the &#39;enabled&#39; attribute
   in the &lt;filter&gt; element, as described in [5].

5.  Server Operation

5.1.  NOTIFY Bodies

   SIP entities compliant with this specification MUST support
   content-type &#39;application/simple-filter+xml&#39;.

5.2.  Notifier Processing of SUBSCRIBE Requests

   This section presents additional functionality required from the
   notifier when filters are used in the bodies of the SUBSCRIBE
   requests.  Normal package-specific functionality is otherwise
   followed.






Khartabil, et al.           Standards Track                     [Page 9]

RFC 4660          Functional Description of Filtering     September 2006


   The notifier will examine the Content-Type header field and will
   return a 415 response if it does not understand the content type
   &#39;application/simple-filter+xml&#39;.

   A 200-class response indicates that the subscription has been
   accepted, and the NOTIFY will be sent immediately.  A &quot;200&quot; response
   indicates that the subscription has been accepted, the user is
   authorized, and the filter is accepted.  A &quot;202&quot; response merely
   indicates that the subscription has been understood, but that the
   authorization may or may not have been granted.  A &quot;202&quot; response
   also indicates that the filters have not been accepted yet.  The
   acceptance of the filters MAY arrive in a subsequent NOTIFY.

   Procedures described in Section 5.4 are followed if an error is
   encountered.

   As indicated in Section 3.3.1, multiple filters can be present in a
   SUBSCRIBE request.  Filters can also be added or modified as
   indicated in Section 3.3.3.  In such circumstances, a server MUST
   check that there are no filters addressed to the same resource or
   domain, and if they are, it MUST reject the SUBSCRIBE request with a
   &quot;488&quot; error response.

5.2.1.  Request-URI vs. Filter URI

   The subscriber may have chosen to leave the URI in the filter
   undefined.  If the URI is not defined within the filter, the filter
   applies to the resource identified in the Request-URI.

   Similarly, the subscriber may have chosen to include a URI in the
   filter.  In this case, the filter applies to all notifications sent
   with content associated with the resource with that URI for this
   subscription.  If the Request-URI and the URI in the filter do not
   match, the filter may be ignored or rejected.  URI matching is done
   according to the matching rules defined for a particular scheme (SIP
   URI matching rules are defined in RFC 3261 [2]).

   A filter may also be addressed to a domain using the &#39;domain&#39;
   attribute instead of the &#39;uri&#39; attribute.  In this case, the filter
   applies to resources in that domain.  A notifier MUST ignore any
   filter using a &#39;domain&#39; attribute containing a domain for which this
   notifier is not responsible.  The notifier MUST NOT apply such a
   filter to any notification it sends.  Notifiers belonging to the
   domain MUST apply the filter to all notifications it sends for that
   subscription, unless policy dictates otherwise.






Khartabil, et al.           Standards Track                    [Page 10]

RFC 4660          Functional Description of Filtering     September 2006


5.2.2.  Changing Filters within a Dialog

   If a server receives a subscription refresh request with no filters
   specified (empty payload), it assumes that the client does not wish
   to update the filters.  If it receives a subscription refresh with a
   filter containing the &#39;remove=&quot;true&quot;&#39; attribute, as defined in [5],
   the server assumes that the client is removing the filter identified
   by the filter ID.

   If the server receives a subscription refresh request with a filter
   that already exists (i.e., having the same filter ID), it interprets
   it as a replacement of the existing filter.  Replacing a filter by
   changing the filter ID and keeping the resource URI is considered an
   error since this causes the server to assume that two filters are
   placed for the same resource.

5.3.  Notifier Generating of NOTIFY Requests

   Upon receiving the SUBSCRIBE with the filter, the notifier SHOULD
   retain the filter as long as the subscription persists.  The filter
   MAY be incorporated within an existing subscription (in an active
   dialog) by sending a re-SUBSCRIBE that includes the filter in the
   body.

   If the response sent to the SUBSCRIBE was a &quot;202&quot; and the &quot;202&quot; was
   chosen because the filter could not be accepted that time, the NOTIFY
   MAY be used to terminate the subscription if the filter is found
   unacceptable.

   As described in [3], the NOTIFY message MAY contain a body that
   describes the state of the resource.  This body is in one of the
   formats listed in the Accept header field of the SUBSCRIBE, or in the
   package-specific default if the Accept header field is omitted.

   Based on the contents of a filter, the following processing occurs:

   o  A filter with only a &lt;what&gt; element will result in sending the
      requested resource state information in that &lt;what&gt; element
      whenever there is a change in the resource state.

   o  A filter with only a &lt;trigger&gt; element will result in sending all
      resource state information whenever there is a change in the
      resource state that matches the triggers.

   o  A filter with &lt;what&gt; and &lt;trigger&gt; elements will result in sending
      the requested resource state information in that &lt;what&gt; element
      whenever there is a change in the resource state that matches the
      triggers.



Khartabil, et al.           Standards Track                    [Page 11]

RFC 4660          Functional Description of Filtering     September 2006


   When a filter is disabled (by setting the &#39;enabled&#39; attribute to
   &quot;false&quot;), it means the same thing as the absence of that filter.
   That is, all state and state changes are reported by issuing a
   notification to the subscriber (assuming there are no other filters).

   When a filter is re-enabled (by setting the &#39;enabled&#39; attribute to
   &quot;true&quot; or by omitting the &#39;enabled&#39; attribute), the notifier behaves
   as if the filter has just been placed by the SUBSCRIBE request
   enabling it.  Immediate NOTIFY rules, as stated in Section 5.3.1,
   apply.

5.3.1.  Generation of NOTIFY Contents

   If the NOTIFY being sent is the one sent immediately after a 2xx
   response to the original SUBSCRIBE, its contents MUST be populated
   according to the filter &lt;what&gt; element, unless the processing of the
   filters will take too long or the NOTIFY request is following a &quot;202&quot;
   response to the SUBSCRIBE request and is terminating the
   subscription.  In the case that the filter is taking too long to
   process, the NOTIFY request being sent may be empty or may be
   populated with a pre-configured value as authorised to that
   subscriber.  If applying the filter results in no content to be
   delivered, the NOTIFY MUST be sent with empty contents.  If the
   filter contains &lt;trigger&gt; elements, the notifier ignores the trigger
   values when generating the first NOTIFY request.

   The input to the content filter is a package-specific XML document
   (e.g., [7] and [9]) derived according to the package-specific
   specifications, (e.g., [8] and [10]).

   The content is filtered according to the expressions in the &lt;what&gt;
   element of the filter.  The expression indicates the delivered XML
   elements and/or attributes.  Prefixes of the namespaces of the items
   of the XML document to be filtered must be expanded before applying
   the filter to the items.

   The expression directly states the XML elements and attributes to be
   delivered in the NOTIFY, along with their values.  In addition to the
   selected contents, the namespaces of all the selected items are also
   included in the NOTIFY.  The XML elements and/or attributes indicated
   by the expression in the &lt;what&gt; element must be items that the
   subscriber is authorised to see.  If they are not, the notifier
   policy dictates the behaviour of the notifier (which can ignore the
   filter, parts of the filter, or reject the filter completely).
   Implementers need to carefully consider such an implementation
   decision; the subscriber may not be aware of the authorised contents
   and therefore most likely will include a filter requesting
   unauthorised contents.  It is therefore RECOMMENDED that notifiers



Khartabil, et al.           Standards Track                    [Page 12]

RFC 4660          Functional Description of Filtering     September 2006


   just ignore the parts of the filter that are requesting unauthorised
   info (i.e., the filter in the &lt;filter&gt; element where the unauthorised
   contents are requested is ignored).  If polite blocking is used by
   the notifier, the notifier may choose to deliver notifications
   containing bogus information in the unauthorised elements or
   attributes and applying the filter afterwards.

   The resultant XML document MUST be well formed and valid according to
   the XML schema.  This means that all mandatory elements and
   attributes, along with their values, MUST be included in the XML
   document regardless of the expression.  In other words, if the result
   of applying a filter on an XML document is a non-valid XML document,
   the notifier MUST add elements and attributes, along with their
   values, from the original XML document into the newly formulated one
   in order for it to be valid.

5.3.2.  Handling of Notification Triggering Rules

   There can be several &lt;trigger&gt; elements inside one &lt;filter&gt; element.
   If the criteria for any of the &lt;trigger&gt; elements are satisfied, a
   NOTIFY SHOULD be generated.

   The items (XML elements and/or attributes) indicated by the
   expression in the &lt;changed&gt; element, &lt;added&gt; element, or &lt;removed&gt;
   element must be items that the subscriber is authorised to access.
   If they are not, the notifier policy dictates the behaviour of the
   notifier (which can ignore the filter, parts of the filter, or reject
   the filter completely).

5.4.  Handling Abnormal Cases

   In case of an invalid filter definition where the XML document of the
   filter is not aligned with the XML schema of the filter format [5],
   the notifier rejects the SUBSCRIBE request with a &quot;488&quot; response.  A
   Warning header field in the response may give a better indication as
   to why the filters were not accepted.  If the subscription was
   accepted with a &quot;202&quot; response but the invalid filter was discovered
   after that, a NOTIFY with a subscription-state of value &#39;terminated&#39;
   is sent.  An event-reason-value &quot;badfilter&quot;, introduced here, of
   subexp-params [3] MAY be included.

   In case of an erroneous expression in the filter definition, the
   notifier either ignores the filter definition or terminates the
   subscription.

   If a &lt;what&gt; or &lt;trigger&gt; element is empty, the notifier proceeds as
   if the element did not exist.




Khartabil, et al.           Standards Track                    [Page 13]

RFC 4660          Functional Description of Filtering     September 2006


6.  XML Document Validation

   The subscriber of the filter MUST ensure that the XML document
   inserted as the SUBSCRIBE request body is well formed and valid.  The
   subscriber MUST NOT insert any extension elements or attributes into
   the XML document unless it has access to the extension schema and can
   validate the XML document.  The XML document notifier MAY validate
   the XML document according to the schemas, including extension
   schemas, to which it has access that are applicable to this XML
   document.

7.  Examples

   The following sections include filtering examples for Presence and
   Watcher Information.  The format of filter is according to [5].

7.1.  Presence Specific Examples

   This section describes three use cases where the presence information
   filtering solution is utilised [8].  In the first use case, the
   watcher is interested in getting messaging-specific information of a
   certain presentity.  In the second use case, the watcher is
   interested in getting information about the communication means and
   contact addresses on which the presentity is currently available for
   communication.  The third case shows how a presentity can request
   triggers to receive notifications.

   Below is the presentity&#39;s presence information in PIDF [7].  It
   includes two tuples: one for the instant messaging and another for
   the voice-related information.

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
         &lt;presence xmlns=&quot;urn:ietf:params:xml:ns:pidf&quot;
                           xmlns:rpid=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;
                           entity=&quot;sip:presentity@example.com&quot;&gt;
            &lt;tuple id=&quot;432sd&quot;&gt;
               &lt;status&gt;
                  &lt;basic&gt;closed&lt;/basic&gt;
               &lt;/status&gt;
               &lt;rpid:class&gt;IM&lt;/rpid:class&gt;
               &lt;contact&gt;im:presentity@example.com&lt;/contact&gt;
            &lt;/tuple&gt;
            &lt;tuple id=&quot;thr76jk&quot;&gt;
               &lt;status&gt;
                  &lt;basic&gt;open&lt;/basic&gt;
               &lt;/status&gt;
               &lt;rpid:class&gt;voice&lt;/rpid:class&gt;
               &lt;contact&gt;tel:2224055555@example.com&lt;/contact&gt;



Khartabil, et al.           Standards Track                    [Page 14]

RFC 4660          Functional Description of Filtering     September 2006


            &lt;/tuple&gt;
         &lt;/presence&gt;

7.1.1.  Subscriber Requests Messaging-Related Information

   The subscriber initiates a subscription to the presentity&#39;s messaging
   (MMS, IM, and SMS) related presence information.  The subscription
   includes the content limiting filter.

   The filtered content is indicated with an expression.  This
   expression selects the &lt;basic&gt; element and all the parent elements
   (i.e., the &lt;status&gt;, the &lt;tuple&gt;, and its root element), the &lt;class&gt;
   element, and the &lt;contact&gt; element.  The filter matches if the
   &lt;class&gt; element contains &quot;MMS&quot;, &quot;SMS&quot;, or &quot;IM&quot;.

   In this case, the notification includes the contents of the tuple
   that has the value &quot;IM&quot; in its &lt;class&gt; element.

   SUBSCRIBE request from the subscriber including filter:

   SUBSCRIBE sip:presentity@example.com
   Via: SIP/2.0/TCP client.example.com:5060;branch=z9hG4bKxjfdsjfk
   To: &lt;sip:presentity@example.com&gt;
   From: &lt;sip:watcher@example.com&gt;;tag:12341111
   Call-ID: 32432udfidfjmk342
   Cseq: 1 SUBSCRIBE
   Expires: 3600
   Event: Presence
   Contact: &lt;sip:watcher@client.example.com&gt;
   Content-Type: application/simple-filter+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;pidf&quot; urn=&quot;urn:ietf:params:xml:ns:pidf&quot;/&gt;
       &lt;ns-binding prefix=&quot;rpid&quot;
                          urn=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;123&quot; uri=&quot;sip:presentity@example.com&quot;&gt;
       &lt;what&gt;
         &lt;include type=&quot;xpath&quot;&gt;
           //pidf:tuple[rpid:class=&quot;IM&quot; or rpid:class=&quot;SMS&quot;
           or rpid:class=&quot;MMS&quot;]/pidf:status/pidf:basic
       &lt;/include&gt;
       &lt;include type=&quot;xpath&quot;&gt;
         //pidf:tuple[rpid:class=&quot;IM&quot; or rpid:class=&quot;SMS&quot;
         or rpid:class=&quot;MMS&quot;]/rpid:class



Khartabil, et al.           Standards Track                    [Page 15]

RFC 4660          Functional Description of Filtering     September 2006


       &lt;/include&gt;
       &lt;include type=&quot;xpath&quot;&gt;
         //pidf:tuple[rpid:class=&quot;IM&quot; or rpid:class=&quot;SMS&quot;
         or rpid:class=&quot;MMS&quot;]/pidf:contact
       &lt;/include&gt;
       &lt;/what&gt;
     &lt;/filter&gt;
   &lt;/filter-set&gt;

   Notification to the subscriber:

   NOTIFY sip:watcher@client.example.com SIP/2.0
   Via: SIP/2.0/TCP presence.example.com:5060;branch=z9hG4bKxjfder
   To: &lt;sip:watcher@example.com&gt;;tag:12341111
   From: &lt;sip:presentity@example.com&gt;;tag:232321
   Call-ID: 32432udfidfjmk342
   Cseq: 1 NOTIFY
   Event: Presence
   Subscription-State: active; expires=3599
   Contact: sip:presentity@server.example.com
   Content-Type: application/pidf+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
      &lt;presence xmlns=&quot;urn:ietf:params:xml:ns:pidf&quot;
      xmlns:rpid=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;
      entity=&quot;sip:presentity@example.com&quot;&gt;
         &lt;tuple id=&quot;432sd&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;closed&lt;/basic&gt;
            &lt;/status&gt;
            &lt;rpid:class&gt;IM&lt;/rpid:class&gt;
            &lt;contact&gt;im:presentity@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
      &lt;/presence&gt;

7.1.2.  Subscriber Fetches Information about &quot;Open&quot; Communication Means

   The subscriber makes a subscription to the presentity&#39;s available
   communication means.  The subscription includes the content-limiting
   filter.

   The filtered content is indicated with an expression.  This
   expression selects the &lt;basic&gt; element and all the parent elements
   (i.e., the &lt;status&gt;, the &lt;tuple&gt;, and its root element), the &lt;class&gt;
   element, and the &lt;contact&gt; element.  The filter matches if the
   &lt;basic&gt; element&#39;s value is &quot;open&quot;.




Khartabil, et al.           Standards Track                    [Page 16]

RFC 4660          Functional Description of Filtering     September 2006


   In this case, the notification returns the contents of the tuple that
   has the value &quot;open&quot; inside the &lt;status&gt; element.

   SUBSCRIBE request from the subscriber including filter:

   SUBSCRIBE sip:presentity@example.com SIP/2.0
   Via: SIP/2.0/TCP client.example.com:5060;branch=z9hG4bKxjfdsjfk
   To: &lt;sip:presentity@example.com&gt;
   From: &lt;sip:watcher@example.com&gt;;tag:12341111
   Call-ID: 32432udfidfjmk342
   Cseq: 1 SUBSCRIBE
   Expires: 3600
   Event: Presence
   Contact: &lt;sip:watcher@client.example.com&gt;
   Content-Type: application/simple-filter+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;pidf&quot; urn=&quot;urn:ietf:params:xml:ns:pidf&quot;/&gt;
       &lt;ns-binding prefix=&quot;rpid&quot;
                          urn=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;123&quot; uri=&quot;sip:presentity@example.com&quot;&gt;
       &lt;what&gt;
         &lt;include type=&quot;xpath&quot;&gt;
           //pidf:tuple/pidf:status[pidf:basic=&quot;open&quot;]/pidf:basic
         &lt;/include&gt;
         &lt;include type=&quot;xpath&quot;&gt;
           //pidf:tuple[pidf:status/pidf:basic=&quot;open&quot;]/rpid:class
         &lt;/include&gt;
         &lt;include type=&quot;xpath&quot;&gt;
           //pidf:tuple[pidf:status/pidf:basic=&quot;open&quot;]/pidf:contact
         &lt;/include&gt;
       &lt;/what&gt;
     &lt;/filter&gt;
   &lt;/filter-set&gt;

   Notification to the subscriber:

   NOTIFY sip:watcher@client.example.com SIP/2.0
   Via: SIP/2.0/TCP presence.example.com:5060;branch=z9hG4bKxjfder
   To: &lt;sip:watcher@example.com&gt;;tag:12341111
   From: &lt;sip:presentity@example.com&gt;;tag:232321
   Call-ID: 32432udfidfjmk342
   Cseq: 1 NOTIFY
   Event: Presence



Khartabil, et al.           Standards Track                    [Page 17]

RFC 4660          Functional Description of Filtering     September 2006


   Subscription-State: active; expires=3599
   Contact: sip:presentity@server.example.com
   Content-Type: application/pidf+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
      &lt;presence xmlns=&quot;urn:ietf:params:xml:ns:pidf&quot;
      xmlns:rpid=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;
      entity=&quot;sip:presentity@example.com&quot;&gt;
         &lt;tuple id=&quot;thr76jk&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;open&lt;/basic&gt;
            &lt;/status&gt;
               &lt;rpid:class&gt;voice&lt;/rpid:class&gt;
               &lt;contact&gt;tel:2224055555@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
      &lt;/presence&gt;

7.1.3.  Subscriber Requests Notifications When Presentity&#39;s Status
        Changes

   The subscriber subscribes to the presentity, specifying in the filter
   that it wants notifications only when the &lt;basic&gt; element has changed
   to value &quot;open&quot;.

   SUBSCRIBE request from the subscriber including filter:

   SUBSCRIBE sip:presentity@example.com
   Via: SIP/2.0/TCP client.example.com:5060;branch=z9hG4bKxjfdsjfk
   To: &lt;sip:presentity@example.com&gt;
   From: &lt;sip:watcher@example.com&gt;;tag:12341111
   Call-ID: 32432udfidfjmk342
   Cseq: 1 SUBSCRIBE
   Expires: 3600
   Event: Presence
   Contact: &lt;sip:watcher@client.example.com&gt;
   Content-Type: application/simple-filter+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;pidf&quot; urn=&quot;urn:ietf:params:xml:ns:pidf&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;123&quot; uri=&quot;sip:presentity@example.com&quot;&gt;
       &lt;trigger&gt;
         &lt;changed from=&quot;closed&quot; to=&quot;open&quot;&gt;
           /pidf:presence/pidf:tuple/pidf:status/pidf:basic



Khartabil, et al.           Standards Track                    [Page 18]

RFC 4660          Functional Description of Filtering     September 2006


         &lt;/changed&gt;
       &lt;/trigger&gt;
     &lt;/filter&gt;
   &lt;/filter-set&gt;

   At some point during the subscription, a second PIDF document is
   created with both tuples having a status of &quot;closed&quot;:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
      &lt;presence xmlns=&quot;urn:ietf:params:xml:ns:pidf&quot;
      xmlns:rpid=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;
      entity=&quot;sip:presentity@example.com&quot;&gt;
         &lt;tuple id=&quot;432sd&quot;&gt;
            &lt;status&gt;
              &lt;basic&gt;closed&lt;/basic&gt;
            &lt;/status&gt;
               &lt;rpid:class&gt;IM&lt;/rpid:class&gt;
               &lt;contact&gt;im:presentity@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
         &lt;tuple id=&quot;thr76jk&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;closed&lt;/basic&gt;
            &lt;/status&gt;
            &lt;rpid:class&gt;voice&lt;/rpid:class&gt;
            &lt;contact&gt;tel:2224055555@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
      &lt;/presence&gt;

   A NOTIFY is not sent to the subscriber in this case.

   Now, a third PIDF document is created when the IM status changes to
   &quot;open&quot;:

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
      &lt;presence xmlns=&quot;urn:ietf:params:xml:ns:pidf&quot;
      xmlns:rpid=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;
      entity=&quot;sip:presentity@example.com&quot;&gt;
         &lt;tuple id=&quot;432sd&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;open&lt;/basic&gt;
            &lt;/status&gt;
            &lt;rpid:class&gt;IM&lt;/rpid:class&gt;
            &lt;contact&gt;im:presentity@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
         &lt;tuple id=&quot;thr76jk&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;closed&lt;/basic&gt;
            &lt;/status&gt;



Khartabil, et al.           Standards Track                    [Page 19]

RFC 4660          Functional Description of Filtering     September 2006


            &lt;rpid:class&gt;voice&lt;/rpid:class&gt;
            &lt;contact&gt;tel:2224055555@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
      &lt;/presence&gt;

   Notification containing both tuples is sent to the subscriber in this
   case:

   NOTIFY sip:watcher@client.example.com SIP/2.0
   Via: SIP/2.0/TCP presence.example.com:5060;branch=z9hG4bKxjfder
   To: &lt;sip:watcher@example.com&gt;;tag:12341111
   From: &lt;sip:presentity@example.com&gt;;tag:232321
   Call-ID: 32432udfidfjmk342
   Cseq: 1 NOTIFY
   Event: Presence
   Subscription-State: active; expires=3599
   Contact: sip:presentity@server.example.com
   Content-Type: application/pidf+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
      &lt;presence xmlns=&quot;urn:ietf:params:xml:ns:pidf&quot;
      xmlns:rpid=&quot;urn:ietf:params:xml:ns:pidf:rpid&quot;
      entity=&quot;sip:presentity@example.com&quot;&gt;
         &lt;tuple id=&quot;432sd&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;closed&lt;/basic&gt;
            &lt;/status&gt;
            &lt;rpid:class&gt;IM&lt;/rpid:class&gt;
            &lt;contact&gt;im:presentity@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
         &lt;tuple id=&quot;thr76jk&quot;&gt;
            &lt;status&gt;
               &lt;basic&gt;open&lt;/basic&gt;
            &lt;/status&gt;
            &lt;rpid:class&gt;voice&lt;/rpid:class&gt;
            &lt;contact&gt;tel:2224055555@example.com&lt;/contact&gt;
         &lt;/tuple&gt;
      &lt;/presence&gt;












Khartabil, et al.           Standards Track                    [Page 20]

RFC 4660          Functional Description of Filtering     September 2006


7.2.  Watcher Information Specific Examples

   The examples in this section use the winfo template-package with the
   presence event package [10].

   Watcher information to a Presentity:

      &lt;?xml version=&quot;1.0&quot;?&gt;
        &lt;watcherinfo xmlns=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;
      version=&quot;0&quot; state=&quot;full&quot;&gt;
        &lt;watcher-list resource=&quot;sip:presentity@example.com&quot;
                      package=&quot;presence&quot;&gt;
            &lt;watcher status=&quot;active&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;509&quot;
               expiration=&quot;20&quot;
               event=&quot;approved&quot;&gt;sip:watcherA@example.com&quot;&lt;/watcher&gt;
            &lt;watcher status=&quot;pending&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;501&quot;
               expiration=&quot;100&quot;
               event=&quot;subscribe&quot;&gt;sip:watcherB@example.com&quot;&lt;/watcher&gt;
            &lt;watcher status=&quot;terminated&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;500&quot;
               expiration=&quot;0&quot;
               event=&quot;rejected&quot;&gt;sip:watcherC@example.com&quot;&lt;/watcher&gt;
            &lt;watcher status=&quot;active&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;20&quot;
               expiration=&quot;30&quot;
               event=&quot;approved&quot;&gt;sip:watcherD@example.com&quot;&lt;/watcher&gt;
        &lt;/watcher-list&gt;
        &lt;/watcherinfo&gt;

















Khartabil, et al.           Standards Track                    [Page 21]

RFC 4660          Functional Description of Filtering     September 2006


7.2.1.  Watcher Subscriber Makes Subscription to Get All the Information
        about Active Watchers

   SUBSCRIBE request from the presentity including the filter:

   SUBSCRIBE sip:presentity@example.com
   Via: SIP/2.0/TCP client.example.com:5060;branch=z9hG4bKxjfdsjfk
   To: &lt;sip:presentity@example.com&gt;
   From: &lt;sip:presentity@example.com&gt;;tag:12341111
   Call-ID: 32432udfidfjmk342
   Cseq: 1 SUBSCRIBE
   Expires: 3600
   Event: Presence.winfo
   Contact: sip:presentity@client.example.com
   Content-Type: application/simple-filter+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;wi&quot;
                          urn=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;123&quot; uri=&quot;sip:presentity@example.com&quot;&gt;
       &lt;what&gt;
         &lt;include&gt;
           /wi:watcherinfo/wi:watcher-list[@package=&quot;presence&quot;]/
           wi:watcher[@status=&quot;active&quot;]
         &lt;/include&gt;
   &lt;/what&gt;
   &lt;/filter&gt;
   &lt;/filter-set&gt;

   Notification to the subscriber:

   NOTIFY sip:presentity@client.example.com SIP/2.0
   Via: SIP/2.0/TCP presence.example.com:5060;branch=z9hG4bKxjfder
   To: sip:presentity@example.com;tag:12341111
   From: sip:presentity@example.com;tag:232321
   Call-ID: 32432udfidfjmk342
   Cseq: 1 NOTIFY
   Contact: sip:presentity@server.example.com
   Event: Presence.winfo

   Content-Type: application/watcherinfo+xml
   Content-Length: ...





Khartabil, et al.           Standards Track                    [Page 22]

RFC 4660          Functional Description of Filtering     September 2006


   &lt;?xml version=&quot;1.0&quot;?&gt;
     &lt;watcherinfo xmlns=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;
   version=&quot;0&quot; state=&quot;full&quot;&gt;
     &lt;watcher-list resource=&quot;sip:presentity@example.com&quot;
                   package=&quot;presence&quot;&gt;
         &lt;watcher status=&quot;active&quot;
            id=&quot;sr8fdsj&quot;
            duration-subscribed=&quot;509&quot;
            expiration=&quot;20&quot;
            event=&quot;approved&quot;&gt;sip:watcherA@example.com&quot;&lt;/watcher&gt;
         &lt;watcher status=&quot;active&quot;
            id=&quot;sr8fdsj&quot;
            duration-subscribed=&quot;20&quot;
            expiration=&quot;30&quot;
            event=&quot;approved&quot;&gt;sip:watcherD@example.com&quot;&lt;/watcher&gt;
     &lt;/watcher-list&gt;
     &lt;/watcherinfo&gt;

7.2.2.  Watcher Subscriber Requests Information of Watchers with
        Specific Subscription Duration Conditions

   SUBSCRIBE request from the presentity including the filter:

   SUBSCRIBE sip:presentity@example.com
   Via: SIP/2.0/TCP client.example.com:5060;branch=z9hG4bKxjfdsjfk
   To: &lt;sip:presentity@example.com&gt;;tag:12341111
   From: &lt;sip:presentity@example.com&gt;
   Call-ID: 32432udfidfjmk342
   Cseq: 1 SUBSCRIBE
   Expires: 0
   Event: Presence.winfo
   Contact: &lt;sip:presentity@client.example.com&gt;
   Content-Type: application/simple-filter+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;wi&quot;
                          urn=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;123&quot; uri=&quot;sip:presentity@example.com&quot;&gt;
       &lt;what&gt;
         &lt;include&gt;
           /wi:watcherinfo/wi:watcher-list[@package=&quot;presence&quot;]/
           wi:watcher[@duration-subscribed&gt;500]
         &lt;/include&gt;
       &lt;/what&gt;



Khartabil, et al.           Standards Track                    [Page 23]

RFC 4660          Functional Description of Filtering     September 2006


     &lt;/filter&gt;
   &lt;/filter-set&gt;

   Notification to the subscriber:

   NOTIFY sip:presentity@client.example.com SIP/2.0
   Via: SIP/2.0/TCP presence.example.com:5060;branch=z9hG4bKxjfder
   To: sip:presentity@example.com;tag:12341111
   From: sip:presentity@example.com;tag:232321
   Call-ID: 32432udfidfjmk342
   Cseq: 1 NOTIFY
   Contact: sip:presentity@server.example.com
   Event: Presence.winfo

   Content-Type: application/watcherinfo+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot;?&gt;
     &lt;watcherinfo xmlns=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;
   version=&quot;0&quot; state=&quot;full&quot;&gt;
     &lt;watcher-list resource=&quot;sip:presentity@example.com&quot;
                   package=&quot;presence&quot;&gt;
         &lt;watcher status=&quot;active&quot;
            id=&quot;sr8fdsj&quot;
            duration-subscribed=&quot;509&quot;
            expiration=&quot;20&quot;
            event=&quot;approved&quot;&gt;sip:watcherA@example.com&quot;&lt;/watcher&gt;
         &lt;watcher status=&quot;pending&quot;
            id=&quot;sr8fdsj&quot;
            duration-subscribed=&quot;501&quot;
            expiration=&quot;100&quot;
            event=&quot;subscribe&quot;&gt;sip:watcherB@example.com&quot;&lt;/watcher&gt;
     &lt;/watcher-list&gt;
     &lt;/watcherinfo&gt;

7.2.3.  Watcher Subscriber Requests Specific Watcher Info on Specific
        Triggers

   This filter selects watcher information notifications [9] to be sent
   when the pending subscription status has changed from &quot;pending&quot; to
   &quot;terminated&quot;.  In the notification, only the watchers that have a
   status of &quot;terminated&quot; and an event of &quot;rejected&quot; are included.

   SUBSCRIBE request from the Watcher Subscriber including the filter:

   SUBSCRIBE sip:presentity@example.com
   Via: SIP/2.0/TCP client.example.com:5060;branch=z9hG4bKxjfdsjfk
   To: &lt;sip:presentity@example.com&gt;;tag:12341111



Khartabil, et al.           Standards Track                    [Page 24]

RFC 4660          Functional Description of Filtering     September 2006


   From: &lt;sip:presentity@example.com&gt;
   Call-ID: 32432udfidfjmk342
   Cseq: 1 SUBSCRIBE
   Expires: 0
   Event: Presence.winfo
   Contact: &lt;sip:presentity@client.example.com&gt;
   Content-Type: application/simple-filter+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
   &lt;filter-set xmlns=&quot;urn:ietf:params:xml:ns:simple-winfo-filter&quot;&gt;
     &lt;ns-bindings&gt;
       &lt;ns-binding prefix=&quot;wi&quot;
                          urn=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;/&gt;
     &lt;/ns-bindings&gt;
     &lt;filter id=&quot;123&quot; uri=&quot;sip:presentity@example.com&quot;&gt;
       &lt;what&gt;
         &lt;include&gt;
           /wi:watcherinfo/wi:watcher-list[@package=&quot;presence&quot;]/
           wi:watcher[@status=&quot;terminated&quot; and @event=&quot;rejected&quot;]
         &lt;/include&gt;
       &lt;/what&gt;
       &lt;trigger&gt;
         &lt;changed from=&quot;pending&quot;
                                             to=&quot;terminated&quot;&gt;
           //@status
         &lt;/changed&gt;
       &lt;/trigger&gt;
     &lt;/filter&gt;
   &lt;/filter-set&gt;

   At some point during the subscription, a second Winfo document is
   created due to some change:

    &lt;?xml version=&quot;1.0&quot;?&gt;
        &lt;watcherinfo xmlns=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;
      version=&quot;0&quot; state=&quot;full&quot;&gt;
        &lt;watcher-list resource=&quot;sip:presentity@example.com&quot;
                      package=&quot;presence&quot;&gt;
            &lt;watcher status=&quot;active&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;509&quot;
               expiration=&quot;20&quot;
               event=&quot;approved&quot;&gt;sip:watcherA@example.com&quot;&lt;/watcher&gt;
            &lt;watcher status=&quot;terminated&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;501&quot;
               expiration=&quot;100&quot;



Khartabil, et al.           Standards Track                    [Page 25]

RFC 4660          Functional Description of Filtering     September 2006


               event=&quot;rejected&quot;&gt;sip:watcherB@example.com&quot;&lt;/watcher&gt;
            &lt;watcher status=&quot;terminated&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;500&quot;
               expiration=&quot;0&quot;
               event=&quot;rejected&quot;&gt;sip:watcherC@example.com&quot;&lt;/watcher&gt;
            &lt;watcher status=&quot;active&quot;
               id=&quot;sr8fdsj&quot;
               duration-subscribed=&quot;20&quot;
               expiration=&quot;30&quot;
               event=&quot;approved&quot;&gt;sip:watcherD@example.com&quot;&lt;/watcher&gt;
       &lt;/watcher-list&gt;
        &lt;/watcherinfo&gt;

   Notification to the subscriber is created, taking into account the
   &lt;trigger&gt; and &lt;what&gt; elements:

   NOTIFY sip:presentity@client.example.com SIP/2.0
   Via: SIP/2.0/TCP presence.example.com:5060;branch=z9hG4bKxjfder
   To: sip:presentity@example.com;tag:12341111
   From: sip:presentity@example.com;tag:232321
   Call-ID: 32432udfidfjmk342
   Cseq: 1 NOTIFY
   Contact: sip:presentity@server.example.com
   Event: Presence.winfo

   Content-Type: application/watcherinfo+xml
   Content-Length: ...

   &lt;?xml version=&quot;1.0&quot;?&gt;
     &lt;watcherinfo xmlns=&quot;urn:ietf:params:xml:ns:watcherinfo&quot;
   version=&quot;0&quot; state=&quot;full&quot;&gt;
     &lt;watcher-list resource=&quot;sip:presentity@example.com&quot;
                   package=&quot;presence&quot;&gt;
         &lt;watcher status=&quot;terminated&quot;
            id=&quot;sr8fdsj&quot;
            duration-subscribed=&quot;501&quot;
            expiration=&quot;100&quot;
            event=&quot;rejected&quot;&gt;sip:watcherB@example.com&quot;&lt;/watcher&gt;
         &lt;watcher status=&quot;terminated&quot;
            id=&quot;sr8fdsj&quot;
            duration-subscribed=&quot;500&quot;
            expiration=&quot;0&quot;
            event=&quot;rejected&quot;&gt;sip:watcherC@example.com&quot;&lt;/watcher&gt;
     &lt;/watcher-list&gt;
     &lt;/watcherinfo&gt;





Khartabil, et al.           Standards Track                    [Page 26]

RFC 4660          Functional Description of Filtering     September 2006


8.  Security Considerations

   The presence of filters in the body of a SIP message has a
   significant effect on the ways in which the request is handled at a
   server.  As a result, it is especially important that messages
   containing this extension be authenticated and authorized.
   Authentication can be achieved using the Digest Authentication
   mechanism described in [2].  The authorisation decision is based on
   the permissions that the resource (notifier) has given to the
   watcher.  An example of such auhorisation policy can be found in
   [11].

   Processing of requests and looking up filters requires set operations
   and searches, which can require some amount of computation.  This
   enables a DoS attack whereby a user can send requests with
   substantial numbers of messages with large contents, in the hopes of
   overloading the server.  To counter this, the server can establish a
   limit on the number of occurrences of the &lt;what&gt;, &lt;changed&gt;, &lt;added&gt;,
   and &lt;removed&gt; elements that are allowed in the filters.  A default
   limit of 40 is RECOMMENDED; however, servers may raise or lower the
   limit depending upon their specific engineered capacity.

   Requests can reveal sensitive information about a User Agent&#39;s (UA&#39;s)
   capabilities.  If this information is sensitive, it SHOULD be
   encrypted using SIP S/MIME capabilities [6].  All package-specific
   security measures MUST be followed.

   Propagating filters in SUBSCRIBE requests to foreign domains reveals
   sensitive information about a user&#39;s resource lists.  It is therefore
   required that an RLS does not forward a filter if that filter is
   addressed to a resource that is under the administrative domain of
   the RLS, but that is not on the resource list.  Section 4.1 shows an
   example where such a scenario can occur.

   Note that a filtered document located at a subscriber may project
   false reality.  For example, if a subscriber asked to be notified
   when a resource has changed his presence state from &quot;closed&quot; to
   &quot;open&quot; but not from &quot;open&quot; to &quot;closed&quot;, then the subscriber may
   afterwards be under the false impression that the resource&#39;s presence
   state is &quot;open&quot;, even long after the resource has changed it to
   &quot;closed&quot;.  Therefore, subscribers need to be sure what they put in a
   filter, understand what they asked for, and be prepared to be out of
   sync with the real state of a resource.








Khartabil, et al.           Standards Track                    [Page 27]

RFC 4660          Functional Description of Filtering     September 2006


9.  IANA Considerations

   A new event-reason-value &quot;badfilter&quot; is defined to represent the
   event where the filter is not well formed and/or not accepted.  No
   IANA registration is required for this value.

10.  Acknowledgements

   The authors would like to thank George Foti, Tim Moran, Sreenivas
   Addagatla, Juha Kalliokulju, Jari Urpalainen, and Mary Barnes for
   their valuable input.

11.  References

11.1.  Normative References

   [1]  Bradner, S., &quot;Key words for use in RFCs to Indicate Requirement
        Levels&quot;, BCP 14, RFC 2119, March 1997.

   [2]  Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A.,
        Peterson, J., Sparks, R., Handley, M., and E. Schooler, &quot;SIP:
        Session Initiation Protocol&quot;, RFC 3261, June 2002.

   [3]  Roach, A.B., &quot;Session Initiation Protocol (SIP)-Specific Event
        Notification&quot;, RFC 3265, June 2002.
<font color='red'><s>

   [4]  Roach, A.B., Campbell, B., and J. Rosenberg, &quot;A Session
        Initiation Protocol (SIP) Event Notification Extension for
        Resource Lists&quot;, RFC 4663, September 2006.

   </s></font></pre><div style='overflow:auto;border:dashed;margin:8px;padding:24px;background-color:#FFFFAF;'><b><i>The preceding text has been updated by Editorial <a href='https://www.rfc-editor.org/errata/eid32'>Errata 32</a> to instead read:</i></b><pre style='margin:20px'>

   [4]  Roach, A.B., Campbell, B., and J. Rosenberg, &quot;A Session
        Initiation Protocol (SIP) Event Notification Extension for
        Resource Lists&quot;, RFC 4662, August 2006.

</pre></div><pre>
[5]  Khartabil, H., Leppanen, E., Lonnfors, M., and J. Costa-Requena,
        &quot;An Extensible Markup Language (XML)-Based Format for Event
        Notification Filtering&quot;, RFC 4661, September 2006.

   [6]  Ramsdell, B., &quot;Secure/Multipurpose Internet Mail Extensions
        (S/MIME) Version 3.1 Message Specification&quot;, RFC 3851, July
        2004.

11.2.  Informative References

   [7]  Sugano, H., Fujimoto, S., Klyne, G., Bateman, A., Carr, W., and
        J. Peterson, &quot;Presence Information Data Format (PIDF)&quot;, RFC
        3863, August 2004.

   [8]  Rosenberg, J., &quot;A Presence Event Package for the Session
        Initiation Protocol (SIP)&quot;, RFC 3856, August 2004.





Khartabil, et al.           Standards Track                    [Page 28]

RFC 4660          Functional Description of Filtering     September 2006


   [9]  Rosenberg, J., &quot;An Extensible Markup Language (XML) Based Format
        for Watcher Information&quot;, RFC 3858, August 2004.

   [10] Rosenberg, J., &quot;A Watcher Information Event Template-Package for
        the Session Initiation Protocol (SIP)&quot;, RFC 3857, August 2004.

   [11] Rosenberg, J., &quot;Presence Authorization Rules&quot;, Work in Progress,
        June 2006.











































Khartabil, et al.           Standards Track                    [Page 29]

RFC 4660          Functional Description of Filtering     September 2006


Authors&#39; Addresses

   Hisham Khartabil
   Telio
   P.O. Box 1203 Vika
   Oslo
   Norway

   Phone: +47 2167 3544
   EMail: hisham.khartabil@telio.no


   Eva Leppanen
   Nokia
   P.O BOX 785
   Tampere
   Finland

   Phone: +358 7180 77066
   EMail: eva-maria.leppanen@nokia.com


   Mikko Lonnfors
   Nokia
   P.O BOX 321
   Helsinki
   Finland

   Phone: + 358 71800 8000
   EMail: mikko.lonnfors@nokia.com


   Jose Costa-Requena
   Nokia
   P.O. Box 321
   FIN-00045 NOKIA GROUP
   FINLAND

   Phone: +358 71800 8000
   EMail: jose.costa-requena@nokia.com











Khartabil, et al.           Standards Track                    [Page 30]

RFC 4660          Functional Description of Filtering     September 2006


Full Copyright Statement

   Copyright (C) The Internet Society (2006).

   This document is subject to the rights, licenses and restrictions
   contained in BCP 78, and except as set forth therein, the authors
   retain all their rights.

   This document and the information contained herein are provided on an
   &quot;AS IS&quot; basis and THE CONTRIBUTOR, THE ORGANIZATION HE/SHE REPRESENTS
   OR IS SPONSORED BY (IF ANY), THE INTERNET SOCIETY AND THE INTERNET
   ENGINEERING TASK FORCE DISCLAIM ALL WARRANTIES, EXPRESS OR IMPLIED,
   INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE USE OF THE
   INFORMATION HEREIN WILL NOT INFRINGE ANY RIGHTS OR ANY IMPLIED
   WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.

Intellectual Property

   The IETF takes no position regarding the validity or scope of any
   Intellectual Property Rights or other rights that might be claimed to
   pertain to the implementation or use of the technology described in
   this document or the extent to which any license under such rights
   might or might not be available; nor does it represent that it has
   made any independent effort to identify any such rights.  Information
   on the procedures with respect to rights in RFC documents can be
   found in BCP 78 and BCP 79.

   Copies of IPR disclosures made to the IETF Secretariat and any
   assurances of licenses to be made available, or the result of an
   attempt made to obtain a general license or permission for the use of
   such proprietary rights by implementers or users of this
   specification can be obtained from the IETF on-line IPR repository at
   http://www.ietf.org/ipr.

   The IETF invites any interested party to bring to its attention any
   copyrights, patents or patent applications, or other proprietary
   rights that may cover technology that may be required to implement
   this standard.  Please address the information to the IETF at
   ietf-ipr@ietf.org.

Acknowledgement

   Funding for the RFC Editor function is provided by the IETF
   Administrative Support Activity (IASA).







Khartabil, et al.           Standards Track                    [Page 31]

</pre>